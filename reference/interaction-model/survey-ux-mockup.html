<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Electric Twin — Survey Creator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  @import url('https://fonts.cdnfonts.com/css/cabinet-grotesk');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --black: #111111; --dark: #222222; --mid: #666666; --light: #AAAAAA;
    --rule: #E5E5E5; --bg: #FFFFFF; --off: #FAFAFA; --hover: #F5F5F5;
    --selected-bg: #F0F0F0; --text: #111111;
  }
  body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }

  /* Nav */
  .nav { position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 0 40px; height: 56px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--rule); }
  .nav-logo { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 18px; font-weight: 700; }
  .nav-steps { display: flex; gap: 0; align-items: center; }
  .nav-step { display: flex; align-items: center; gap: 6px; padding: 6px 16px; font-size: 12px; font-weight: 500; color: var(--light); cursor: default; }
  .nav-step.active { color: var(--black); }
  .nav-step.done { color: var(--mid); }
  .nav-step .num { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; border: 1px solid var(--rule); color: var(--light); }
  .nav-step.active .num { background: var(--black); color: var(--bg); border-color: var(--black); }
  .nav-step.done .num { color: var(--mid); border-color: var(--mid); }
  .nav-arrow { color: var(--rule); font-size: 14px; }
  .nav-right { display: flex; gap: 12px; align-items: center; }

  /* Mode toggle — now in floating settings */
  .mode-toggle { display: flex; gap: 0; border: 1px solid var(--rule); font-size: 11px; }
  .mode-btn { padding: 5px 14px; cursor: pointer; background: var(--bg); border: none; font-family: inherit; font-size: 11px; font-weight: 500; color: var(--mid); border-right: 1px solid var(--rule); }
  .mode-btn:last-child { border-right: none; }
  .mode-btn.active { background: var(--black); color: var(--bg); }
  .btn-save { background: none; border: 1px solid var(--rule); padding: 5px 14px; font-size: 11px; font-weight: 500; color: var(--mid); cursor: pointer; font-family: inherit; }

  /* Floating settings panel */
  .proto-settings-trigger { position: fixed; bottom: 20px; left: 20px; z-index: 9000; width: 36px; height: 36px; border-radius: 50%; background: var(--bg); color: var(--light); border: 1px solid var(--rule); cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 6px rgba(0,0,0,0.06); transition: all 0.2s; }
  .proto-settings-trigger:hover { color: var(--black); border-color: var(--mid); }
  .proto-settings-trigger.open { color: var(--black); border-color: var(--mid); }
  .proto-settings-panel { position: fixed; bottom: 66px; left: 20px; z-index: 9000; background: var(--bg); border: 1px solid var(--rule); box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 20px; width: 240px; display: none; }
  .proto-settings-panel.open { display: block; }
  .proto-settings-panel .ps-title { font-size: 9px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 12px; }
  .proto-settings-panel .ps-label { font-size: 12px; color: var(--mid); margin-bottom: 8px; }
  .proto-settings-panel .ps-desc { font-size: 11px; color: var(--light); margin-top: 12px; line-height: 1.5; }

  /* Container */
  .screen { max-width: 1100px; margin: 0 auto; padding: 48px 40px 64px; }
  .screen-step { font-size: 11px; font-weight: 600; letter-spacing: 0.12em; color: var(--light); margin-bottom: 12px; }
  .screen-title { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 32px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.02em; }
  .screen-sub { font-size: 15px; color: var(--mid); margin-bottom: 40px; }

  /* Sections (single-page mode) */
  .section { margin-bottom: 0; transition: all 0.3s; }
  .section-divider { border: none; border-top: 1px solid var(--rule); margin: 48px 0; }

  /* Wizard mode: show only active screen */
  body.wizard .wizard-screen { display: none; }
  body.wizard .wizard-screen.wizard-active { display: block; }
  body.wizard .section-divider { display: none; }

  /* Single-page mode: show all, progressive reveal */
  body.single-page .wizard-screen { display: block !important; }
  body.single-page .section-divider { display: block; }
  body.single-page .section.locked { opacity: 0.3; pointer-events: none; filter: blur(1px); }
  body.single-page .section.locked .section-lock-msg { display: block; }
  body.single-page .btn-row-wizard { display: none; }
  body.single-page .nav-steps { display: none; }

  .section-lock-msg { display: none; text-align: center; padding: 20px; font-size: 13px; color: var(--light); font-style: italic; }

  /* Page-builder mode: sidebar TOC + focused main area */
  body.page-builder { display: flex; flex-direction: column; }
  body.page-builder .nav-steps { display: none; }
  body.page-builder .btn-row-wizard { display: none; }
  body.page-builder .section-divider { display: none; }
  body.page-builder .wizard-screen { display: none; }
  body.page-builder .wizard-screen.wizard-active { display: block; }
  .pb-layout { display: none; }
  body.page-builder .pb-layout { display: flex; min-height: calc(100vh - 56px); }

  /* Sidebar */
  .pb-sidebar { width: 240px; flex-shrink: 0; border-right: 1px solid var(--rule); padding: 24px 0; position: sticky; top: 56px; height: calc(100vh - 56px); overflow-y: auto; background: var(--bg); }
  .pb-sidebar-title { font-size: 9px; font-weight: 600; letter-spacing: 0.12em; color: var(--light); padding: 0 20px; margin-bottom: 16px; }
  .pb-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; transition: all 0.1s; border-left: 2px solid transparent; }
  .pb-item:hover { background: var(--hover); }
  .pb-item.active { background: var(--selected-bg); border-left-color: var(--black); }
  .pb-item.done { }
  .pb-item.locked { opacity: 0.35; pointer-events: none; }
  .pb-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; flex-shrink: 0; border: 1.5px solid var(--rule); color: var(--light); }
  .pb-item.active .pb-dot { background: var(--black); color: var(--bg); border-color: var(--black); }
  .pb-item.done .pb-dot { border-color: var(--mid); color: var(--mid); }
  .pb-item.done .pb-dot::after { content: '✓'; }
  .pb-item.done .pb-dot span { display: none; }
  .pb-label { font-size: 13px; font-weight: 500; color: var(--mid); }
  .pb-item.active .pb-label { color: var(--black); font-weight: 600; }
  .pb-status { font-size: 9px; margin-left: auto; color: var(--light); font-weight: 500; }
  .pb-item.done .pb-status { color: var(--mid); }
  .pb-item.active .pb-status { color: var(--black); }

  /* Main content in page-builder */
  .pb-main { flex: 1; position: relative; overflow-y: auto; height: calc(100vh - 56px); }

  /* Confirm bar for builder mode */
  .pb-confirm { display: none; position: fixed; bottom: 0; left: 240px; right: 0; background: var(--bg); border-top: 1px solid var(--rule); padding: 14px 40px; z-index: 100; align-items: center; justify-content: space-between; }
  .pb-confirm.visible { display: flex; }
  .pb-confirm-label { font-size: 13px; color: var(--mid); transition: all 0.15s; }
  .pb-confirm-label strong { color: var(--black); font-weight: 600; }
  .pb-confirm-label.hint { color: var(--light); font-style: italic; }
  .pb-confirm-actions { display: flex; gap: 10px; }
  .pb-confirm-btn { padding: 10px 28px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.15s; }
  .pb-confirm-primary { background: var(--black); color: var(--bg); }
  .pb-confirm-primary:hover { background: var(--dark); }
  .pb-confirm-primary:disabled { background: var(--rule); color: var(--light); cursor: default; }
  .pb-confirm-secondary { background: var(--bg); color: var(--mid); border: 1px solid var(--rule); }
  .pb-confirm-secondary:hover { border-color: var(--black); color: var(--black); }

  /* Cards */
  .type-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--rule); border: 1px solid var(--rule); margin-bottom: 16px; }
  .type-card { background: var(--bg); padding: 28px; cursor: pointer; transition: all 0.15s; position: relative; }
  .type-card:hover { background: var(--hover); }
  .type-card.selected { background: var(--selected-bg); }
  .type-card.selected::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--black); }
  .type-card .type-num { font-size: 11px; color: var(--light); margin-bottom: 12px; font-weight: 500; }
  .type-card h3 { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 17px; font-weight: 700; margin-bottom: 6px; }
  .type-card p { font-size: 12px; color: var(--mid); line-height: 1.6; }
  .tags { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
  .tag { font-size: 9px; font-weight: 500; padding: 2px 7px; border: 1px solid var(--rule); color: var(--mid); letter-spacing: 0.03em; }
  .template-row { display: flex; align-items: center; padding: 16px 28px; border: 1px solid var(--rule); cursor: pointer; transition: all 0.15s; }
  .template-row:hover { background: var(--hover); }

  /* Audience */
  .aud-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--rule); border: 1px solid var(--rule); margin-bottom: 24px; }
  .aud-card { background: var(--bg); padding: 32px; cursor: pointer; transition: all 0.15s; }
  .aud-card:hover { background: var(--hover); }
  .aud-card.selected { background: var(--selected-bg); }
  .aud-card h3 { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .aud-card p { font-size: 13px; color: var(--mid); }
  .segment-panel { border: 1px solid var(--rule); }
  .segment-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--rule); }
  .segment-header .title { font-size: 13px; font-weight: 600; }
  .segment-header .total { font-size: 12px; color: var(--mid); }
  .segment-cols { display: grid; grid-template-columns: 10px 1fr 2fr 80px; gap: 12px; align-items: center; padding: 10px 24px; font-size: 10px; font-weight: 600; color: var(--light); letter-spacing: 0.08em; border-bottom: 1px solid var(--rule); }
  .segment-row { display: grid; grid-template-columns: 10px 1fr 2fr 80px; gap: 12px; align-items: center; padding: 14px 24px; border-bottom: 1px solid var(--rule); }
  .segment-row:last-of-type { border-bottom: none; }
  .seg-dot { width: 8px; height: 8px; border-radius: 50%; }
  .seg-name { font-size: 13px; font-weight: 500; }
  .seg-criteria { font-size: 12px; color: var(--mid); }
  .seg-sample { font-size: 12px; color: var(--mid); text-align: right; }
  .add-seg { padding: 12px 24px; font-size: 13px; color: var(--mid); font-weight: 500; cursor: pointer; border-top: 1px solid var(--rule); background: none; border-left: none; border-right: none; border-bottom: none; width: 100%; text-align: left; font-family: inherit; }
  .add-seg:hover { color: var(--black); background: var(--hover); }
  .single-aud-panel { border: 1px solid var(--rule); padding: 32px; }
  .single-aud-panel h4 { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
  .single-aud-panel p { font-size: 13px; color: var(--mid); margin-bottom: 16px; }
  .input-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .input-field { flex: 1; padding: 10px 14px; border: 1px solid var(--rule); font-size: 13px; font-family: inherit; color: var(--text); background: var(--bg); }
  .input-field:focus { outline: none; border-color: var(--black); }

  /* Audience picker */
  .aud-picker-label { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 12px; }
  .aud-suggestions { display: flex; flex-direction: column; gap: 1px; background: var(--rule); border: 1px solid var(--rule); margin-bottom: 16px; }
  .aud-suggestion { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; background: var(--bg); cursor: pointer; transition: all 0.1s; position: relative; }
  .aud-suggestion:hover { background: var(--hover); }
  .aud-suggestion.picked { background: var(--selected-bg); }
  .aud-suggestion.picked::before { content: ''; display: inline-block; width: 2px; height: 100%; background: var(--black); position: absolute; left: 0; top: 0; }
  .aud-sug-left {}
  .aud-sug-name { font-size: 13px; font-weight: 500; }
  .aud-sug-desc { font-size: 11px; color: var(--mid); margin-top: 2px; }
  .aud-sug-meta { text-align: right; flex-shrink: 0; }
  .aud-sug-size { font-size: 12px; font-weight: 600; }
  .aud-sug-geo { font-size: 10px; color: var(--light); }
  .aud-custom { padding: 12px 20px; font-size: 13px; color: var(--mid); cursor: pointer; border: 1px dashed var(--rule); text-align: center; transition: all 0.15s; margin-top: 12px; }
  .aud-custom:hover { border-color: var(--mid); color: var(--black); }

  /* Build */
  .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--rule); border: 1px solid var(--rule); margin-bottom: 32px; }
  .build-card { background: var(--bg); padding: 32px 24px; cursor: pointer; transition: all 0.15s; text-align: center; position: relative; }
  .build-card:hover { background: var(--hover); }
  .build-card.selected { background: var(--selected-bg); }
  .build-card.selected::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--black); }
  .build-card h3 { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .build-card p { font-size: 11px; color: var(--mid); line-height: 1.6; }
  .ai-tag { display: inline-block; margin-top: 8px; font-size: 9px; font-weight: 600; letter-spacing: 0.06em; padding: 2px 8px; border: 1px solid var(--black); }
  .build-panel { border: 1px solid var(--rule); padding: 32px; display: none; }
  .build-panel.active { display: block; }
  .build-panel h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .build-panel .sub { font-size: 12px; color: var(--mid); margin-bottom: 20px; }

  /* Side-by-side input layout */
  .ai-input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 0; align-items: stretch; }
  .ai-input-col { display: flex; flex-direction: column; }
  .ai-input-col-label { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 10px; }
  .ai-input-hint { font-size: 11px; color: var(--light); margin-top: 12px; text-align: center; font-style: italic; }
  .textarea-mock { width: 100%; flex: 1; min-height: 0; padding: 16px; border: 1px solid var(--rule); font-size: 14px; font-family: inherit; color: var(--text); resize: none; background: var(--off); }
  .textarea-mock:focus { outline: none; border-color: var(--black); background: var(--bg); }
  .upload-zone { border: 1px dashed var(--rule); padding: 40px; text-align: center; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-height: 0; }
  .upload-zone:hover { border-color: var(--mid); background: var(--hover); }
  .upload-zone-icon { margin-bottom: 12px; color: var(--light); transition: color 0.15s; }
  .upload-zone:hover .upload-zone-icon { color: var(--mid); }
  .upload-zone-title { font-size: 13px; font-weight: 500; margin-bottom: 3px; }
  .upload-zone-sub { font-size: 11px; color: var(--light); }

  .stim-section { margin-top: 24px; border-top: 1px solid var(--rule); padding-top: 20px; }
  .stim-section-label { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 4px; }
  .stim-section-sub { font-size: 12px; color: var(--mid); margin-bottom: 14px; }
  .stim-upload-row { display: flex; gap: 12px; }
  .stim-upload-zone { flex: 1; border: 1px dashed var(--rule); padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .stim-upload-zone:hover { border-color: var(--mid); background: var(--hover); }
  .stim-upload-zone .stim-icon { margin-bottom: 10px; color: var(--light); transition: color 0.15s; }
  .stim-upload-zone:hover .stim-icon { color: var(--mid); }
  .stim-upload-zone .stim-label { font-size: 12px; font-weight: 500; }
  .stim-upload-zone .stim-sub { font-size: 10px; color: var(--light); margin-top: 2px; }
  .stim-preview { display: flex; gap: 12px; margin-top: 12px; }
  .stim-thumb-card { flex: 1; border: 1px solid var(--rule); padding: 12px; display: flex; align-items: center; gap: 10px; }
  .stim-thumb-img { width: 48px; height: 48px; background: var(--off); border: 1px solid var(--rule); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 10px; color: var(--light); }
  .stim-thumb-info { flex: 1; }
  .stim-thumb-name { font-size: 12px; font-weight: 500; }
  .stim-thumb-meta { font-size: 10px; color: var(--light); }
  .stim-thumb-remove { font-size: 11px; color: var(--light); cursor: pointer; padding: 4px; }
  .stim-thumb-remove:hover { color: var(--black); }
  .stim-skip { font-size: 11px; color: var(--light); margin-top: 10px; cursor: pointer; }
  .stim-skip:hover { color: var(--mid); }
  .template-option { display: flex; align-items: center; padding: 14px 20px; border-bottom: 1px solid var(--rule); cursor: pointer; transition: all 0.1s; }
  .template-option:hover { background: var(--hover); }
  .template-option:last-child { border-bottom: none; }
  .template-option .tname { font-size: 14px; font-weight: 500; flex: 1; }
  .template-option .tqs { font-size: 12px; color: var(--light); }
  .template-option.selected { background: var(--selected-bg); }
  .template-option.selected::before { content: ''; display: inline-block; width: 2px; height: 100%; background: var(--black); position: absolute; left: 0; top: 0; }
  .template-option { position: relative; }

  /* Question Editor — 2-panel layout */
  .builder-layout { display: grid; grid-template-columns: 220px 1fr; gap: 0; min-height: 520px; }
  .q-list-panel { padding: 0 20px 20px 0; position: sticky; top: 0; align-self: start; max-height: calc(100vh - 56px); overflow-y: auto; }
  .q-list-header { font-size: 10px; font-weight: 600; color: var(--light); letter-spacing: 0.1em; margin-bottom: 14px; }
  .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: grab; margin-bottom: 2px; transition: all 0.1s; font-size: 13px; color: var(--mid); }
  .q-item:hover { background: var(--hover); }
  .q-item.active { background: var(--selected-bg); color: var(--black); font-weight: 500; }
  .q-item.dragging { opacity: 0.3; }
  .q-item.drag-over { border-top: 2px solid var(--black); margin-top: -2px; }
  .q-item .q-drag-handle { flex-shrink: 0; color: var(--rule); font-size: 11px; cursor: grab; user-select: none; letter-spacing: 1px; margin-right: -4px; }
  .q-item:hover .q-drag-handle { color: var(--mid); }
  .q-item .q-num { width: 20px; height: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--light); border: 1px solid var(--rule); }
  .q-item.active .q-num { background: var(--black); color: var(--bg); border-color: var(--black); }
  .q-type-badge { font-size: 9px; font-weight: 500; color: var(--light); margin-left: auto; }
  .upload-q-btn { width: 100%; margin-bottom: 16px; padding: 12px 14px; border: 1.5px dashed var(--mid); background: var(--off); font-size: 12px; color: var(--dark); font-weight: 600; cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 10px; transition: all 0.15s; }
  .upload-q-btn:hover { border-color: var(--black); background: var(--hover); color: var(--black); }
  .upload-q-btn svg { flex-shrink: 0; }
  .upload-q-btn span { line-height: 1.3; }
  .add-q-btn { width: 100%; margin-top: 12px; padding: 8px; border: 1px dashed var(--rule); background: none; font-size: 12px; color: var(--mid); font-weight: 500; cursor: pointer; font-family: inherit; }
  .q-editor { padding: 32px 36px; border: 1px solid var(--rule); }
  .q-editor-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .q-editor-label { font-size: 11px; color: var(--light); font-weight: 500; }

  /* Custom type dropdown */
  .q-type-trigger { display: flex; align-items: center; gap: 8px; padding: 6px 14px; border: 1px solid var(--rule); cursor: pointer; font-size: 12px; font-weight: 500; color: var(--black); background: var(--bg); font-family: inherit; transition: all 0.15s; position: relative; }
  .q-type-trigger:hover { border-color: var(--black); }
  .q-type-trigger .qt-icon { font-size: 14px; line-height: 1; }
  .q-type-trigger .qt-label { flex: 1; }
  .q-type-trigger .qt-arrow { font-size: 10px; color: var(--light); transition: transform 0.2s; }
  .q-type-trigger.open .qt-arrow { transform: rotate(180deg); }
  .q-type-dropdown { position: absolute; top: calc(100% + 4px); right: 0; width: 240px; background: var(--bg); border: 1px solid var(--rule); box-shadow: 0 8px 24px rgba(0,0,0,0.08); z-index: 200; display: none; }
  .q-type-dropdown.open { display: block; }
  .q-type-dropdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; cursor: pointer; transition: all 0.1s; font-size: 13px; color: var(--mid); }
  .q-type-dropdown-item:hover { background: var(--hover); color: var(--black); }
  .q-type-dropdown-item.selected { background: var(--selected-bg); color: var(--black); font-weight: 500; }
  .q-type-dropdown-item .qtd-icon { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }
  .q-type-dropdown-item .qtd-info { flex: 1; }
  .q-type-dropdown-item .qtd-name { font-size: 13px; }
  .q-type-dropdown-item .qtd-desc { font-size: 10px; color: var(--light); margin-top: 1px; }
  .q-type-dropdown-item.selected .qtd-desc { color: var(--mid); }

  .q-input { width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid var(--rule); font-size: 18px; font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-weight: 700; color: var(--black); background: none; }
  .q-input:focus { outline: none; border-bottom-color: var(--black); }
  .answers-label { font-size: 10px; font-weight: 600; color: var(--light); letter-spacing: 0.1em; margin: 24px 0 12px; }
  .answer-option { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--rule); font-size: 14px; }
  .answer-radio { width: 16px; height: 16px; border-radius: 50%; border: 1.5px solid var(--rule); flex-shrink: 0; }
  .answer-text { flex: 1; border: none; background: none; font-size: 14px; font-family: inherit; color: var(--text); }
  .answer-drag { color: var(--rule); cursor: grab; font-size: 12px; }
  .add-option { padding: 8px 0; font-size: 12px; color: var(--mid); cursor: pointer; border: none; background: none; font-family: inherit; font-weight: 500; }

  /* Inline settings row */
  .q-settings-row { display: flex; align-items: center; gap: 20px; margin-top: 20px; padding: 14px 0; border-top: 1px solid var(--rule); }
  .q-setting { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--mid); }
  .toggle-track { width: 32px; height: 18px; border-radius: 9px; position: relative; cursor: pointer; background: var(--rule); transition: background 0.2s; flex-shrink: 0; }
  .toggle-track.on { background: var(--black); }
  .toggle-thumb { width: 14px; height: 14px; border-radius: 50%; background: var(--bg); position: absolute; top: 2px; left: 2px; transition: left 0.2s; }
  .toggle-track.on .toggle-thumb { left: 16px; }

  /* Stimulus preview in editor — compact thumbnails */
  .stim-preview-bar { margin: -32px -36px 24px; padding: 12px 36px; background: var(--off); border-bottom: 1px solid var(--rule); display: flex; align-items: center; gap: 14px; }
  .stim-preview-label { font-size: 9px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); white-space: nowrap; }
  .stim-preview-images { display: flex; gap: 10px; flex: 1; }
  .stim-preview-card { display: flex; align-items: center; gap: 10px; border: 1px solid var(--rule); background: var(--bg); padding: 6px 12px 6px 6px; cursor: pointer; transition: border-color 0.15s; }
  .stim-preview-card:hover { border-color: var(--mid); }
  .stim-preview-card.active-concept { border-color: var(--black); }
  .stim-preview-card.active-concept .stim-preview-badge { background: var(--black); color: var(--bg); border-color: var(--black); }
  .stim-preview-thumb { width: 64px; height: 44px; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .stim-preview-thumb .placeholder-icon { font-size: 18px; }
  .stim-preview-card-info { display: flex; flex-direction: column; gap: 2px; }
  .stim-preview-name { font-size: 12px; font-weight: 500; }
  .stim-preview-badge { font-size: 9px; font-weight: 600; padding: 1px 6px; border: 1px solid var(--rule); color: var(--mid); letter-spacing: 0.03em; align-self: flex-start; }
  .stim-expand-btn { margin-left: auto; font-size: 11px; color: var(--light); cursor: pointer; border: 1px solid var(--rule); background: var(--bg); padding: 4px 10px; font-family: inherit; white-space: nowrap; transition: all 0.15s; flex-shrink: 0; }
  .stim-expand-btn:hover { border-color: var(--black); color: var(--black); }

  /* Stimulus full preview (review page, lightbox) */
  .stim-preview-full { margin-bottom: 32px; }
  .stim-preview-full .stim-preview-label { margin-bottom: 16px; }
  .stim-preview-full .stim-preview-images { display: flex; gap: 16px; }
  .stim-preview-full .stim-full-card { flex: 1; overflow: hidden; }
  .stim-preview-full .stim-full-card.active-concept { }
  .stim-preview-full .stim-full-card.active-concept .stim-preview-badge { background: var(--black); color: var(--bg); border-color: var(--black); }
  .stim-full-img { width: 100%; aspect-ratio: 16/10; background: var(--off); border: 1px solid var(--rule); display: flex; align-items: center; justify-content: center; }
  .stim-full-img .placeholder-inner { display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .stim-full-img .placeholder-icon { font-size: 28px; color: var(--rule); }
  .stim-full-img .placeholder-text { font-size: 10px; color: var(--light); }
  .stim-full-meta { padding: 8px 0; display: flex; align-items: center; justify-content: space-between; font-family: 'Cabinet Grotesk', 'Inter', sans-serif; }

  /* Lightbox for stimulus expand */
  .stim-lightbox { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
  .stim-lightbox.open { display: flex; }
  .stim-lightbox-inner { background: var(--bg); padding: 32px; max-width: 900px; width: 90%; max-height: 80vh; overflow: auto; position: relative; }
  .stim-lightbox-close { position: absolute; top: 12px; right: 16px; font-size: 20px; cursor: pointer; background: none; border: none; color: var(--mid); font-family: inherit; }
  .stim-lightbox-close:hover { color: var(--black); }

  /* Stimulus survey-level note */
  .stim-survey-note { margin-top: 20px; padding: 14px 16px; background: var(--off); border: 1px solid var(--rule); display: flex; align-items: center; gap: 12px; }
  .stim-survey-note .stim-note-icon { font-size: 16px; flex-shrink: 0; }
  .stim-survey-note .stim-note-text { font-size: 12px; color: var(--mid); flex: 1; }
  .stim-survey-note .stim-note-text strong { color: var(--black); font-weight: 600; }
  .stim-survey-note .stim-note-action { font-size: 11px; color: var(--mid); cursor: pointer; border: 1px solid var(--rule); padding: 4px 10px; background: var(--bg); font-family: inherit; flex-shrink: 0; transition: all 0.15s; }
  .stim-survey-note .stim-note-action:hover { border-color: var(--black); color: var(--black); }

  .ai-box { margin-top: 20px; padding: 16px; border-left: 2px solid var(--black); background: var(--off); }
  .ai-box .ai-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; color: var(--mid); margin-bottom: 6px; }
  .ai-box p { font-size: 12px; color: var(--mid); line-height: 1.6; }

  /* Review */
  .review-layout { display: grid; grid-template-columns: 1fr 300px; gap: 0; }
  .review-main { padding: 0; }
  .review-q { padding: 16px 0; border-bottom: 1px solid var(--rule); display: flex; align-items: flex-start; gap: 14px; }
  .review-q:last-of-type { border-bottom: none; }
  .review-num { width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--light); border: 1px solid var(--rule); }
  .review-content { flex: 1; }
  .review-text { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
  .review-meta { display: flex; gap: 8px; flex-wrap: wrap; }
  .review-badge { font-size: 9px; font-weight: 500; padding: 2px 7px; border: 1px solid var(--rule); color: var(--mid); }
  .review-answers { margin-top: 6px; font-size: 12px; color: var(--light); }
  .review-btn { padding: 4px 10px; border: 1px solid var(--rule); background: var(--bg); font-size: 11px; cursor: pointer; color: var(--mid); font-family: inherit; }
  .review-btn:hover { border-color: var(--black); color: var(--black); }
  .review-sidebar { padding: 0 0 0 32px; position: sticky; top: 0; align-self: start; }
  .sidebar-section { margin-bottom: 20px; padding: 16px; background: var(--off); border: 1px solid var(--rule); border-radius: 8px; }
  .sidebar-section:last-child { }
  .sidebar-title { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; color: var(--light); margin-bottom: 10px; }
  .sidebar-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 12px; }
  .sidebar-row .lbl { color: var(--mid); }
  .sidebar-row .val { color: var(--black); font-weight: 500; font-size: 12px; }
  .review-questions-wrap { border: 1px solid var(--rule); border-radius: 8px; padding: 20px 24px; }
  .stim-thumb { width: 100%; aspect-ratio: 16/9; background: var(--off); border: 1px solid var(--rule); display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--light); margin-bottom: 8px; }
  .seg-dot-row { display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 11px; color: var(--mid); }

  /* Edit survey button — shadcn outline variant */
  .btn-edit-survey { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 500; font-family: inherit; cursor: pointer; background: var(--bg); color: var(--black); border: 1px solid var(--rule); border-radius: 6px; transition: all 0.15s; white-space: nowrap; }
  .btn-edit-survey:hover { background: var(--hover); border-color: var(--mid); }

  /* Results */
  .results-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 32px; }
  .results-tabs { display: flex; border: 1px solid var(--rule); }
  .results-tab { padding: 8px 18px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: var(--bg); color: var(--mid); font-family: inherit; border-right: 1px solid var(--rule); }
  .results-tab:last-child { border-right: none; }
  .results-tab.active { background: var(--black); color: var(--bg); }

  /* Single-column scroll results */
  .results-stream { display: flex; flex-direction: column; gap: 0; border: 1px solid var(--rule); }
  .finding-row { display: grid; grid-template-columns: 300px 1fr; border-bottom: 1px solid var(--rule); }
  .finding-row:last-child { border-bottom: none; }

  /* Left: editable insight column */
  .finding-insight-col { padding: 28px 24px; border-right: 1px solid var(--rule); display: flex; flex-direction: column; }
  .finding-insight-label { font-size: 9px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
  .finding-insight-label .edit-icon { font-size: 11px; color: var(--light); cursor: pointer; transition: color 0.15s; }
  .finding-insight-label .edit-icon:hover { color: var(--black); }
  .finding-insight-text { font-size: 14px; line-height: 1.65; color: var(--dark); flex: 1; }
  .finding-insight-text[contenteditable="true"] { outline: none; border: 1px solid var(--rule); padding: 10px 12px; margin: -10px -12px; background: var(--off); cursor: text; }
  .finding-insight-text[contenteditable="true"]:focus { border-color: var(--black); background: var(--bg); }
  .insight-stat { display: inline-block; font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .insight-note { font-size: 11px; color: var(--light); margin-top: 10px; font-style: italic; }

  /* Right: question data column */
  .finding-data-col { padding: 28px; }
  .finding-q { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; color: var(--light); margin-bottom: 4px; }
  .finding-text { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 20px; }
  .finding-chart { height: 110px; display: flex; align-items: flex-end; gap: 6px; margin-bottom: 16px; padding-bottom: 4px; border-bottom: 1px solid var(--rule); }
  .chart-bar { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
  .chart-bar-val { font-size: 10px; font-weight: 600; margin-bottom: 3px; }
  .chart-bar-fill { width: 100%; }
  .chart-labels { display: flex; gap: 6px; }
  .chart-labels span { flex: 1; text-align: center; font-size: 9px; color: var(--light); }
  .concept-compare { display: flex; gap: 1px; background: var(--rule); border: 1px solid var(--rule); margin-bottom: 16px; }
  .concept-option { flex: 1; background: var(--bg); padding: 20px; text-align: center; }
  .concept-option.winner { background: var(--selected-bg); }
  .concept-pct { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 28px; font-weight: 700; }
  .concept-name { font-size: 11px; color: var(--mid); margin-top: 4px; }
  .finding-segment-bars { margin-top: 16px; }
  .seg-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .seg-bar-label { font-size: 11px; color: var(--mid); width: 80px; text-align: right; flex-shrink: 0; }
  .seg-bar-track { flex: 1; height: 6px; background: var(--off); }
  .seg-bar-fill { height: 100%; }
  .seg-bar-val { font-size: 10px; font-weight: 600; width: 36px; flex-shrink: 0; }

  /* Buttons */
  .btn-row { display: flex; gap: 12px; justify-content: flex-end; margin-top: 40px; }
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 24px; font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer; border: none; transition: all 0.15s; }
  .btn-primary { background: var(--black); color: var(--bg); }
  .btn-primary:hover { background: var(--dark); }
  .btn-secondary { background: var(--bg); color: var(--black); border: 1px solid var(--rule); }
  .btn-secondary:hover { border-color: var(--black); }

  /* Loading overlay */
  .loading-overlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
  .loading-overlay.active { opacity: 1; pointer-events: all; }
  /* In builder mode: overlay only covers the main area, not sidebar/nav */
  body.page-builder .loading-overlay { left: 240px; top: 56px; z-index: 99; }

  /* Sidebar loading state */
  .pb-item .pb-spinner { display: none; width: 14px; height: 14px; border: 1.5px solid var(--rule); border-top-color: var(--black); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: auto; flex-shrink: 0; }
  .pb-item.generating .pb-spinner { display: block; }
  .pb-item.generating .pb-status { display: none; }
  .loading-spinner { width: 32px; height: 32px; border: 2px solid var(--rule); border-top-color: var(--black); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 28px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-step { font-size: 14px; font-weight: 500; color: var(--black); margin-bottom: 6px; min-height: 20px; transition: opacity 0.3s ease; }
  .loading-sub { font-size: 12px; color: var(--light); min-height: 16px; }
  .loading-progress { width: 200px; height: 2px; background: var(--rule); margin-top: 32px; overflow: hidden; }
  .loading-progress-fill { height: 100%; width: 0; background: var(--black); transition: width 0.6s ease; }

  /* Editor tabs — Questions / Stimulus toggle */
  .editor-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--rule); margin-bottom: 24px; }
  .editor-tab { padding: 10px 20px; font-size: 13px; font-weight: 500; color: var(--light); cursor: pointer; border: none; background: none; font-family: inherit; border-bottom: 2px solid transparent; transition: all 0.15s; display: flex; align-items: center; gap: 8px; }
  .editor-tab:hover { color: var(--mid); }
  .editor-tab.active { color: var(--black); border-bottom-color: var(--black); }
  .editor-tab .tab-count { font-size: 10px; font-weight: 600; color: var(--light); background: var(--off); border: 1px solid var(--rule); padding: 0 6px; border-radius: 10px; line-height: 18px; }
  .editor-tab.active .tab-count { color: var(--mid); }

  /* Stimulus config view in editor */
  .stim-config { padding: 0; }
  .stim-config-title { font-family: 'Cabinet Grotesk', 'Inter', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 4px; }
  .stim-config-sub { font-size: 13px; color: var(--mid); margin-bottom: 24px; line-height: 1.6; }
  .stim-config-upload { border: 1px dashed var(--rule); padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s; margin-bottom: 16px; }
  .stim-config-upload:hover { border-color: var(--mid); background: var(--hover); }
  .stim-config-upload .upload-icon { font-size: 24px; color: var(--rule); margin-bottom: 8px; }
  .stim-config-upload .upload-text { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
  .stim-config-upload .upload-hint { font-size: 11px; color: var(--light); }
  .stim-concept-list { display: flex; flex-direction: column; gap: 8px; }
  .stim-concept-card { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--rule); }
  .stim-concept-thumb { width: 56px; height: 40px; background: var(--off); border: 1px solid var(--rule); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; }
  .stim-concept-info { flex: 1; }
  .stim-concept-name { font-size: 13px; font-weight: 500; }
  .stim-concept-meta { font-size: 10px; color: var(--light); margin-top: 2px; }
  .stim-concept-remove { font-size: 14px; color: var(--light); cursor: pointer; padding: 4px; background: none; border: none; }
  .stim-concept-remove:hover { color: #c33; }
  .stim-config-note { margin-top: 16px; padding: 12px; background: var(--off); border: 1px solid var(--rule); font-size: 11px; color: var(--mid); line-height: 1.6; }
  .stim-skip-link { font-size: 11px; color: var(--light); margin-top: 12px; cursor: pointer; }
  .stim-skip-link:hover { color: var(--mid); }

  /* Empty state for manual editor */
  .q-editor-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: var(--light); text-align: center; padding: 40px; }
  .q-editor-empty .empty-icon { font-size: 32px; margin-bottom: 12px; color: var(--rule); }
  .q-editor-empty .empty-title { font-size: 15px; font-weight: 500; color: var(--mid); margin-bottom: 6px; }
  .q-editor-empty .empty-sub { font-size: 12px; color: var(--light); margin-bottom: 20px; }
  .q-editor-empty .empty-add-btn { padding: 10px 24px; font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer; background: var(--black); color: var(--bg); border: none; transition: all 0.15s; }
  .q-editor-empty .empty-add-btn:hover { background: var(--dark); }

  /* Delete question button */
  .q-delete-btn { background: none; border: 1px solid var(--rule); padding: 6px 12px; font-size: 11px; color: var(--light); cursor: pointer; font-family: inherit; transition: all 0.15s; margin-left: 8px; }
  .q-delete-btn:hover { border-color: #e55; color: #c33; }

  /* Remove answer button */
  .answer-remove { color: var(--rule); cursor: pointer; font-size: 14px; padding: 2px 4px; transition: color 0.15s; background: none; border: none; font-family: inherit; }
  .answer-remove:hover { color: #c33; }

  .hidden { display: none !important; }
</style>
</head>
<body class="page-builder">

<!-- ===== GLOBAL NAV ===== -->
<nav class="nav" id="main-nav">
  <div class="nav-logo">ElectricTwin</div>
  <div class="nav-steps" id="nav-steps">
    <div class="nav-step active" data-step="1"><span class="num">1</span> Type</div>
    <span class="nav-arrow">›</span>
    <div class="nav-step" data-step="2"><span class="num">2</span> Audience</div>
    <span class="nav-arrow">›</span>
    <div class="nav-step" data-step="3"><span class="num">3</span> Stimulus*</div>
    <span class="nav-arrow">›</span>
    <div class="nav-step" data-step="4"><span class="num">4</span> Questions</div>
    <span class="nav-arrow">›</span>
    <div class="nav-step" data-step="5"><span class="num">5</span> Preview</div>
  </div>
  <div class="nav-right">
    <button class="btn-save">Save Draft</button>
  </div>
</nav>

<!-- Floating prototype settings -->
<button class="proto-settings-trigger" id="proto-settings-trigger" onclick="toggleProtoSettings()">⚙</button>
<div class="proto-settings-panel" id="proto-settings-panel">
  <div class="ps-title">PROTOTYPE SETTINGS</div>
  <div class="ps-label">Navigation mode</div>
  <div class="mode-toggle">
    <button class="mode-btn" onclick="setMode('wizard')">Wizard</button>
    <button class="mode-btn active" onclick="setMode('page-builder')">Builder</button>
    <button class="mode-btn" onclick="setMode('single-page')">Single Page</button>
  </div>
  <div class="ps-desc">Testing which navigation pattern works best. This control won't be in the final product.</div>
  <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--rule);">
    <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--mid); cursor: pointer;">
      <input type="checkbox" id="dev-mode-toggle" checked onchange="toggleDevMode(this.checked)" style="cursor: pointer;">
      Dev mode <span style="font-size: 10px; color: var(--light);">(unlock all steps)</span>
    </label>
  </div>
</div>

<!-- Page-builder sidebar + main wrapper -->
<div class="pb-layout" id="pb-layout">
  <aside class="pb-sidebar" id="pb-sidebar">
    <div class="pb-sidebar-title">SURVEY BUILDER</div>
    <!-- Sidebar items rendered dynamically by renderSidebar() -->
  </aside>
  <div class="pb-main" id="pb-main"></div>
</div>
<div class="pb-confirm" id="pb-confirm">
  <div class="pb-confirm-label" id="pb-confirm-label"></div>
  <div class="pb-confirm-actions">
    <button class="pb-confirm-btn pb-confirm-secondary" onclick="hidePbConfirm()">Change</button>
    <button class="pb-confirm-btn pb-confirm-primary" id="pb-confirm-go" onclick="confirmPbStep()">Confirm &amp; continue →</button>
  </div>
</div>

<!-- ===== LOADING OVERLAY ===== -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-step" id="loading-step"></div>
  <div class="loading-sub" id="loading-sub"></div>
  <div class="loading-progress"><div class="loading-progress-fill" id="loading-progress-fill"></div></div>
</div>

<!-- ==================== SECTION: QUESTIONS GATEWAY ==================== -->
<div class="wizard-screen" data-screen="questions-gateway">
<div class="screen">
  <div class="section" id="sec-build">
    <div class="screen-step" id="questions-step-label">03 — QUESTIONS</div>
    <h1 class="screen-title">How do you want to add questions?</h1>
    <p class="screen-sub">Upload existing questions, generate with AI, or build from scratch.</p>

    <div class="build-grid" id="build-grid" style="grid-template-columns: 1fr 1fr;">
      <div class="build-card" data-build="ai" onclick="selectBuild(this)" style="text-align:left;">
        <h3>Generate with AI</h3>
        <p>Describe what you need or upload a brief. AI generates your questions.</p>
        <span class="ai-tag">AI</span>
      </div>
      <div class="build-card" data-build="manual" onclick="selectBuild(this)" style="text-align:left;">
        <h3>Build From Scratch</h3>
        <p>Add questions one by one with full control over types and options.</p>
      </div>
    </div>

    <div class="build-panel" id="panel-ai">
      <h4>Tell AI about your research</h4>
      <div class="sub">AI combines everything you provide to generate your survey.</div>

      <div class="ai-input-row">
        <div class="ai-input-col">
          <div class="ai-input-col-label">DESCRIBE</div>
          <textarea class="textarea-mock" id="ai-prompt" placeholder="e.g. Test two plant-based meal kit concepts for appeal, purchase intent, and willingness to pay." oninput="checkBuildReady()"></textarea>
        </div>
        <div class="ai-input-col">
          <div class="ai-input-col-label">UPLOAD A BRIEF</div>
          <div id="brief-upload-zone" class="upload-zone" onclick="simulateBriefUpload()">
            <div class="upload-zone-icon">
              <svg width="48" height="56" viewBox="0 0 48 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 4h22l10 10v38a2 2 0 01-2 2H10a2 2 0 01-2-2V4z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <path d="M30 4v10h10" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                <path d="M16 24h16M16 31h16M16 38h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="upload-zone-title">Drop a brief here or click to browse</div>
            <div class="upload-zone-sub">PDF, DOCX, or TXT — max 10 MB</div>
          </div>
          <div id="brief-uploaded" style="display:none;">
            <div class="stim-thumb-card" style="min-height:160px;">
              <div class="stim-thumb-img" style="font-size:16px;">
                <svg width="24" height="28" viewBox="0 0 48 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 4h22l10 10v38a2 2 0 01-2 2H10a2 2 0 01-2-2V4z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <path d="M30 4v10h10" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
                  <path d="M16 24h16M16 31h16M16 38h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="stim-thumb-info"><div class="stim-thumb-name">research-brief-v12.docx</div><div class="stim-thumb-meta">DOCX · 2.4 MB · Uploaded just now</div></div>
              <span class="stim-thumb-remove" title="Remove" onclick="removeBrief(event)">✕</span>
            </div>
          </div>
        </div>
      </div>
      <div class="ai-input-hint">Use either or both — AI combines everything you provide</div>

      <div class="stim-section" id="stim-ai">
        <div class="stim-section-label">STIMULUS (OPTIONAL)</div>
        <div class="stim-section-sub">Add the concepts, ads, or creatives you're testing.</div>
        <div id="stim-empty-zone" class="stim-upload-zone" style="padding:28px;" onclick="simulateStimUpload()">
          <div class="stim-icon">
            <svg width="56" height="48" viewBox="0 0 56 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="4" width="34" height="26" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <circle cx="13" cy="14" r="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <path d="M2 24l8-7 6 5 5-4 15 12" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              <rect x="22" y="20" width="32" height="24" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <path d="M34 28l10 6-10 6V28z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="stim-label">Add stimulus files</div>
          <div class="stim-sub">Images, videos, PDFs, or text — up to 5 items</div>
        </div>
        <div id="stim-loaded" style="display:none;">
          <div class="stim-preview">
            <div class="stim-thumb-card">
              <div class="stim-thumb-img">A</div>
              <div class="stim-thumb-info"><div class="stim-thumb-name">Concept A — "Fresh & Green"</div><div class="stim-thumb-meta">concept-a.png · 1.2 MB</div></div>
              <span class="stim-thumb-remove" title="Remove" onclick="removeStim(event)">✕</span>
            </div>
            <div class="stim-thumb-card">
              <div class="stim-thumb-img">B</div>
              <div class="stim-thumb-info"><div class="stim-thumb-name">Concept B — "Plant Power"</div><div class="stim-thumb-meta">concept-b.png · 980 KB</div></div>
              <span class="stim-thumb-remove" title="Remove" onclick="removeStim(event)">✕</span>
            </div>
          </div>
          <div style="margin-top:12px;">
            <div class="stim-upload-zone" style="padding:14px;">
              <div class="stim-label">+ Add another stimulus</div>
            </div>
          </div>
          <div class="ai-box" style="margin-top:14px;" id="stim-ai-note"><div class="ai-label">AI NOTE</div><p>Two concept images detected. I'll generate a sequential monadic survey — respondents see each concept and answer the same questions, then compare.</p></div>
        </div>
      </div>
    </div>
    <div class="build-panel" id="panel-manual"><h4>Build from scratch</h4><div class="sub">Start with a blank editor. Add and configure questions one by one.</div></div>

    <!-- Template section -->
    <div id="template-section" style="margin-top:40px; border-top:1px solid var(--rule); padding-top:32px;">
      <div style="font-size:10px; font-weight:600; letter-spacing:0.12em; color:var(--light); margin-bottom:16px;">SELECT A TEMPLATE</div>
      <div style="font-size:13px; color:var(--mid); margin-bottom:20px;">Pre-built questionnaires ready to customise.</div>

      <div style="font-size:9px; font-weight:600; letter-spacing:0.1em; color:var(--light); margin-bottom:10px;">YOUR TEMPLATES</div>
      <div id="panel-template-user" style="border:1px solid var(--rule); margin-bottom:20px;">
        <div class="template-option" onclick="selectTemplate(this, 'Q4 Brand Awareness — UK')"><span class="tname">Q4 Brand Awareness — UK</span><span class="tqs">11 questions · Saved 14 Jan</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Post-Launch NPS')"><span class="tname">Post-Launch NPS</span><span class="tqs">7 questions · Saved 3 Dec</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Creative Pre-Test v2')"><span class="tname">Creative Pre-Test v2</span><span class="tqs">9 questions · Saved 18 Nov</span></div>
      </div>

      <div style="font-size:9px; font-weight:600; letter-spacing:0.1em; color:var(--light); margin-bottom:10px;">ELECTRIC TWIN</div>
      <div id="panel-template-et" style="border:1px solid var(--rule);">
        <div class="template-option" onclick="selectTemplate(this, 'Standard Concept Test')"><span class="tname">Standard Concept Test</span><span class="tqs">8 questions</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Quick Concept Screen')"><span class="tname">Quick Concept Screen</span><span class="tqs">5 questions</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Detailed Concept Evaluation')"><span class="tname">Detailed Concept Evaluation</span><span class="tqs">14 questions</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Comparative Concept Test')"><span class="tname">Comparative Concept Test</span><span class="tqs">10 questions</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Brand Health Tracker')"><span class="tname">Brand Health Tracker</span><span class="tqs">12 questions</span></div>
        <div class="template-option" onclick="selectTemplate(this, 'Audience Explorer')"><span class="tname">Audience Explorer</span><span class="tqs">9 questions</span></div>
      </div>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-primary" onclick="generateAndContinue()">Continue →</button>
    </div>
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 1: TYPE ==================== -->
<div class="wizard-screen wizard-active" data-screen="type">
<div class="screen">
  <div class="section" id="sec-type">
    <div class="screen-step">01 — TYPE</div>
    <h1 class="screen-title">What kind of survey?</h1>
    <p class="screen-sub">Choose a type. This sets the default question structure and stimulus.</p>

    <div class="type-grid" id="type-grid">
      <div class="type-card" data-type="simple" onclick="selectType(this)">
        <div class="type-num">01</div><h3>Simple Survey</h3>
        <p>Straightforward questionnaire. Any question types, no stimulus.</p>
        <div class="tags"><span class="tag">No Stimulus</span><span class="tag">Freeform</span></div>
      </div>
      <div class="type-card" data-type="concept" onclick="selectType(this)">
        <div class="type-num">02</div><h3>Concept Testing</h3>
        <p>Evaluate product concepts. Measures appeal, uniqueness, purchase intent.</p>
        <div class="tags"><span class="tag">Stimulus Required</span><span class="tag">Monadic</span><span class="tag">Comparative</span></div>
      </div>
      <div class="type-card" data-type="message" onclick="selectType(this)">
        <div class="type-num">03</div><h3>Message Testing</h3>
        <p>Test marketing messages and taglines. Compare for clarity and impact.</p>
        <div class="tags"><span class="tag">Text Stimulus</span><span class="tag">Comparative</span></div>
      </div>
      <div class="type-card" data-type="creative" onclick="selectType(this)">
        <div class="type-num">04</div><h3>Creative Testing</h3>
        <p>Evaluate ads, packaging, visual creative. Attention and recall.</p>
        <div class="tags"><span class="tag">Image / Video</span><span class="tag">Monadic</span></div>
      </div>
      <div class="type-card" data-type="brand" onclick="selectType(this)">
        <div class="type-num">05</div><h3>Brand Tracking</h3>
        <p>Recurring brand awareness, perception, consideration over time.</p>
        <div class="tags"><span class="tag">Multi-Wave</span><span class="tag">Scales</span></div>
      </div>
      <div class="type-card" data-type="audience" onclick="selectType(this)">
        <div class="type-num">06</div><h3>Audience Exploration</h3>
        <p>Understand who your audience is. Attitudes, behaviours, and needs.</p>
        <div class="tags"><span class="tag">Segmentation</span><span class="tag">Profiling</span></div>
      </div>
    </div>

    <div class="template-row">
      <span style="font-size:14px;font-weight:600;">Custom Template</span>
      <span style="font-size:12px;color:var(--mid);margin-left:12px;">— start from a saved configuration</span>
      <span style="margin-left:auto;color:var(--light);">→</span>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-secondary" onclick="wizardNext(1)">← Back</button>
      <button class="btn btn-primary" onclick="wizardNext(3)">Continue →</button>
    </div>
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 2: AUDIENCE ==================== -->
<div class="wizard-screen" data-screen="audience">
<div class="screen">
  <div class="section" id="sec-audience">
    <div class="screen-step" id="audience-step-label">02 — AUDIENCE</div>
    <h1 class="screen-title" id="audience-title">Who do you want to survey?</h1>
    <p class="screen-sub">Define your target audience.</p>

    <div class="aud-options" id="aud-options">
      <div class="aud-card" data-aud="single" onclick="selectAudience(this)">
        <h3>Single Audience</h3>
        <p>One target group. General feedback or homogeneous audience.</p>
      </div>
      <div class="aud-card" data-aud="multi" onclick="selectAudience(this)">
        <h3>Multi-Segment</h3>
        <p>Compare across segments. Essential for concept testing and tracking.</p>
      </div>
    </div>

    <div id="multi-panel" class="segment-panel hidden">
      <div class="segment-header"><span class="title">Segments</span><span class="total">Total: <strong>600</strong></span></div>
      <div class="segment-cols"><div></div><div>SEGMENT</div><div>TARGETING</div><div style="text-align:right">SAMPLE</div></div>
      <div class="segment-row"><div class="seg-dot" style="background:#111;"></div><div class="seg-name">Gen Z (18–25)</div><div class="seg-criteria">Age 18–25, UK, Social media users</div><div class="seg-sample">n = 200</div></div>
      <div class="segment-row"><div class="seg-dot" style="background:#666;"></div><div class="seg-name">Millennials (26–40)</div><div class="seg-criteria">Age 26–40, UK, Online shoppers</div><div class="seg-sample">n = 200</div></div>
      <div class="segment-row"><div class="seg-dot" style="background:#AAA;"></div><div class="seg-name">Gen X+ (41–60)</div><div class="seg-criteria">Age 41–60, UK, Brand aware</div><div class="seg-sample">n = 200</div></div>
      <button class="add-seg">+ Add segment</button>
    </div>

    <div id="single-panel" class="single-aud-panel hidden">
      <h4>Target Audience</h4><p>Choose a pre-defined audience or create your own.</p>
      <div class="aud-picker-label">SUGGESTED AUDIENCES</div>
      <div class="aud-suggestions" id="aud-suggestions">
        <div class="aud-suggestion" onclick="pickAudience(this, 'UK adults, 25–55, grocery shoppers')">
          <div class="aud-sug-left"><div class="aud-sug-name">UK Grocery Shoppers</div><div class="aud-sug-desc">Adults 25–55, primary grocery buyer</div></div>
          <div class="aud-sug-meta"><div class="aud-sug-size">n = 300</div><div class="aud-sug-geo">United Kingdom</div></div>
        </div>
        <div class="aud-suggestion" onclick="pickAudience(this, 'US adults, 18–44, health-conscious')">
          <div class="aud-sug-left"><div class="aud-sug-name">US Health-Conscious</div><div class="aud-sug-desc">Adults 18–44, interested in health &amp; wellness</div></div>
          <div class="aud-sug-meta"><div class="aud-sug-size">n = 500</div><div class="aud-sug-geo">United States</div></div>
        </div>
        <div class="aud-suggestion" onclick="pickAudience(this, 'UK adults, 18–35, urban, social media users')">
          <div class="aud-sug-left"><div class="aud-sug-name">UK Young Urban</div><div class="aud-sug-desc">Adults 18–35, urban areas, active on social media</div></div>
          <div class="aud-sug-meta"><div class="aud-sug-size">n = 250</div><div class="aud-sug-geo">United Kingdom</div></div>
        </div>
        <div class="aud-suggestion" onclick="pickAudience(this, 'Global, 25–60, decision makers, B2B')">
          <div class="aud-sug-left"><div class="aud-sug-name">B2B Decision Makers</div><div class="aud-sug-desc">Business professionals 25–60, purchasing authority</div></div>
          <div class="aud-sug-meta"><div class="aud-sug-size">n = 200</div><div class="aud-sug-geo">Global</div></div>
        </div>
        <div class="aud-suggestion" onclick="pickAudience(this, 'UK parents, 28–45, children under 12')">
          <div class="aud-sug-left"><div class="aud-sug-name">UK Parents</div><div class="aud-sug-desc">Parents 28–45 with children under 12</div></div>
          <div class="aud-sug-meta"><div class="aud-sug-size">n = 300</div><div class="aud-sug-geo">United Kingdom</div></div>
        </div>
      </div>
      <div class="aud-custom" onclick="pickAudience(null, 'custom')">+ Define a custom audience</div>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-secondary" onclick="wizardNext(2)">← Back</button>
      <button class="btn btn-primary" onclick="wizardNext(4)">Continue →</button>
    </div>
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 3: STIMULUS ==================== -->
<div class="wizard-screen" data-screen="stimulus">
<div class="screen">
  <div class="section" id="sec-stimulus">
    <div class="screen-step" id="stimulus-step-label">03 — STIMULUS</div>
    <h1 class="screen-title" id="stimulus-title">Add your stimulus materials</h1>
    <p class="screen-sub" id="stimulus-sub">Upload the concepts, ads, or creatives respondents will evaluate.</p>

    <div class="stim-upload-zone" style="padding:40px;" id="stim-gateway-empty" onclick="simulateStimulusStep()">
      <div class="stim-icon">
        <svg width="56" height="48" viewBox="0 0 56 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="4" width="34" height="26" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
          <circle cx="13" cy="14" r="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
          <path d="M2 24l8-7 6 5 5-4 15 12" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="22" y="20" width="32" height="24" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
          <path d="M34 28l10 6-10 6V28z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="stim-label">Drop files here or click to browse</div>
      <div class="stim-sub">Images, videos, PDFs — up to 5 items</div>
    </div>

    <div id="stim-gateway-loaded" style="display:none;">
      <div class="stim-preview">
        <div class="stim-thumb-card">
          <div class="stim-thumb-img">A</div>
          <div class="stim-thumb-info"><div class="stim-thumb-name">Concept A — "Fresh & Green"</div><div class="stim-thumb-meta">concept-a.png · 1.2 MB</div></div>
          <span class="stim-thumb-remove" title="Remove" onclick="removeStimulusItem(event)">✕</span>
        </div>
        <div class="stim-thumb-card">
          <div class="stim-thumb-img">B</div>
          <div class="stim-thumb-info"><div class="stim-thumb-name">Concept B — "Plant Power"</div><div class="stim-thumb-meta">concept-b.png · 980 KB</div></div>
          <span class="stim-thumb-remove" title="Remove" onclick="removeStimulusItem(event)">✕</span>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="stim-upload-zone" style="padding:14px;">
          <div class="stim-label">+ Add another stimulus</div>
        </div>
      </div>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-primary" onclick="wizardNext('editor')">Continue →</button>
    </div>
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 4: EDITOR ==================== -->
<div class="wizard-screen" data-screen="editor">
<div class="screen">
  <div class="section" id="sec-editor">
    <div class="screen-step" id="editor-step-label">QUESTIONS</div>
    <h1 class="screen-title" style="font-size:24px;">Edit Your Questions</h1>
    <p class="screen-sub" style="margin-bottom:24px;">8 questions generated. Edit, reorder, or add more.</p>

    <!-- Editor tabs: Questions / Stimulus -->
    <div class="editor-tabs" id="editor-tabs" style="display:none;">
      <button class="editor-tab active" data-editor-tab="questions" onclick="switchEditorTab('questions')">Questions <span class="tab-count" id="tab-q-count">8</span></button>
      <button class="editor-tab" data-editor-tab="stimulus" onclick="switchEditorTab('stimulus')">Stimulus <span class="tab-count" id="tab-stim-count">Optional</span></button>
    </div>

    <!-- Stimulus config panel (shown when Stimulus tab is active) -->
    <div id="stim-tab-content" style="display:none;"></div>

    <div class="builder-layout" id="builder-layout">
      <div class="q-list-panel" id="q-list-panel">
        <div class="q-list-header">QUESTIONS (8)</div>
        <div class="q-item active" data-qi="0" onclick="selectQuestion(0)"><span class="q-num">1</span> Overall Appeal <span class="q-type-badge">Likert</span></div>
        <div class="q-item" data-qi="1" onclick="selectQuestion(1)"><span class="q-num">2</span> Uniqueness <span class="q-type-badge">Likert</span></div>
        <div class="q-item" data-qi="2" onclick="selectQuestion(2)"><span class="q-num">3</span> Purchase Intent <span class="q-type-badge">Single</span></div>
        <div class="q-item" data-qi="3" onclick="selectQuestion(3)"><span class="q-num">4</span> Key Benefits <span class="q-type-badge">Multi</span></div>
        <div class="q-item" data-qi="4" onclick="selectQuestion(4)"><span class="q-num">5</span> Willingness to Pay <span class="q-type-badge">Single</span></div>
        <div class="q-item" data-qi="5" onclick="selectQuestion(5)"><span class="q-num">6</span> Concept Preference <span class="q-type-badge">Image</span></div>
        <div class="q-item" data-qi="6" onclick="selectQuestion(6)"><span class="q-num">7</span> Improvement Ideas <span class="q-type-badge">Text</span></div>
        <div class="q-item" data-qi="7" onclick="selectQuestion(7)"><span class="q-num">8</span> Overall Feedback <span class="q-type-badge">Slider</span></div>
        <button class="add-q-btn" onclick="addQuestion()">+ Add Question</button>
      </div>
      <div class="q-editor" id="q-editor">
        <!-- Stimulus preview — compact thumbnails -->
        <div class="stim-preview-bar" id="stim-preview-bar">
          <div class="stim-preview-label">STIMULUS</div>
          <div class="stim-preview-images">
            <div class="stim-preview-card active-concept">
              <div class="stim-preview-thumb"><span class="placeholder-icon">🥗</span></div>
              <div class="stim-preview-card-info"><span class="stim-preview-name">Concept A</span><span class="stim-preview-badge">Showing</span></div>
            </div>
            <div class="stim-preview-card">
              <div class="stim-preview-thumb"><span class="placeholder-icon">🍲</span></div>
              <div class="stim-preview-card-info"><span class="stim-preview-name">Concept B</span><span class="stim-preview-badge">Next</span></div>
            </div>
          </div>
          <button class="stim-expand-btn" onclick="openStimLightbox()">Preview ↗</button>
        </div>
        <!-- Editor content (repopulated by JS on question switch) -->
        <div id="q-editor-content">
          <div class="q-editor-header">
            <span class="q-editor-label" id="q-editor-label">Question 3 of 8</span>
            <div style="position:relative;">
              <button class="q-type-trigger" id="q-type-trigger" onclick="toggleTypeDropdown()">
                <span class="qt-icon">◉</span>
                <span class="qt-label">Single Select</span>
                <span class="qt-arrow">▾</span>
              </button>
              <div class="q-type-dropdown" id="q-type-dropdown">
                <div class="q-type-dropdown-item selected" onclick="selectQuestionType(this, '◉', 'Single Select')"><span class="qtd-icon">◉</span><div class="qtd-info"><div class="qtd-name">Single Select</div><div class="qtd-desc">Pick one answer</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '☑', 'Multi Select')"><span class="qtd-icon">☑</span><div class="qtd-info"><div class="qtd-name">Multi Select</div><div class="qtd-desc">Pick multiple answers</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '≡', 'Likert Scale')"><span class="qtd-icon">≡</span><div class="qtd-info"><div class="qtd-name">Likert Scale</div><div class="qtd-desc">Agreement or frequency scale</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '★', 'Rating')"><span class="qtd-icon">★</span><div class="qtd-info"><div class="qtd-name">Rating</div><div class="qtd-desc">Star or number rating</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '▣', 'Image Pick')"><span class="qtd-icon">▣</span><div class="qtd-info"><div class="qtd-name">Image Pick</div><div class="qtd-desc">Choose from images</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '⇅', 'Rank Order')"><span class="qtd-icon">⇅</span><div class="qtd-info"><div class="qtd-name">Rank Order</div><div class="qtd-desc">Drag to rank preferences</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '¶', 'Short Text')"><span class="qtd-icon">¶</span><div class="qtd-info"><div class="qtd-name">Short Text</div><div class="qtd-desc">Open-ended response</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '⟷', 'Slider')"><span class="qtd-icon">⟷</span><div class="qtd-info"><div class="qtd-name">Slider</div><div class="qtd-desc">Drag along a scale</div></div></div>
              </div>
            </div>
          </div>
          <input class="q-input" id="q-input" value="How likely are you to purchase this meal kit service?">
          <div class="answers-label">ANSWER OPTIONS</div>
          <div id="q-answers">
            <div class="answer-option"><div class="answer-radio"></div><input class="answer-text" value="Definitely would purchase" readonly><span class="answer-drag">⠿</span></div>
            <div class="answer-option"><div class="answer-radio"></div><input class="answer-text" value="Probably would purchase" readonly><span class="answer-drag">⠿</span></div>
            <div class="answer-option"><div class="answer-radio"></div><input class="answer-text" value="Might or might not purchase" readonly><span class="answer-drag">⠿</span></div>
            <div class="answer-option"><div class="answer-radio"></div><input class="answer-text" value="Probably would not purchase" readonly><span class="answer-drag">⠿</span></div>
            <div class="answer-option"><div class="answer-radio"></div><input class="answer-text" value="Definitely would not purchase" readonly><span class="answer-drag">⠿</span></div>
          </div>
          <button class="add-option">+ Add option</button>
          <div class="q-settings-row">
            <div class="q-setting"><div class="toggle-track" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></div><span>Randomise options</span></div>
          </div>
          <div class="ai-box" id="q-ai-box"><div class="ai-label">AI SUGGESTION</div><p id="q-ai-text">Standard 5-point purchase intent scale. Consider adding "Not sure / need more info" for undecided respondents.</p></div>
        </div>
      </div>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-secondary" onclick="wizardNext(3)">← Back</button>
      <button class="btn btn-primary" onclick="wizardNext(5)">Preview →</button>
    </div>
    <!-- wizard buttons updated -->
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 5: PREVIEW ==================== -->
<div class="wizard-screen" data-screen="preview">
<div class="screen">
  <div class="section" id="sec-review">
    <div class="screen-step" id="preview-step-label">PREVIEW</div>
    <h1 class="screen-title">Preview</h1>
    <p class="screen-sub">Check everything before launching. ~4 min estimated completion.</p>

    <div class="review-layout">
      <div class="review-main">
        <!-- Stimulus preview — clean, no bordered box -->
        <div class="stim-preview-full">
          <div class="stim-preview-label">STIMULUS</div>
          <div style="font-size: 12px; color: var(--mid); margin-top: -12px; margin-bottom: 16px;">Shown to all respondents · Sequential monadic design</div>
          <div class="stim-preview-images">
            <div class="stim-full-card" onclick="openStimLightbox()" style="cursor:pointer;">
              <div class="stim-full-img"><div class="placeholder-inner"><div class="placeholder-icon">🥗</div><div class="placeholder-text">Plant-based meal kit — Concept A</div></div></div>
              <div class="stim-full-meta"><span class="stim-preview-name">Concept A</span></div>
            </div>
            <div class="stim-full-card" onclick="openStimLightbox()" style="cursor:pointer;">
              <div class="stim-full-img"><div class="placeholder-inner"><div class="placeholder-icon">🍲</div><div class="placeholder-text">Plant-based meal kit — Concept B</div></div></div>
              <div class="stim-full-meta"><span class="stim-preview-name">Concept B</span></div>
            </div>
          </div>
        </div>

        <!-- Questions in bordered container -->
        <div class="review-questions-wrap">
          <div style="font-size: 10px; font-weight: 600; letter-spacing: 0.1em; color: var(--light); margin-bottom: 12px;">QUESTIONS (8)</div>
          <div class="review-q"><div class="review-num">1</div><div class="review-content"><div class="review-text">How appealing is this meal kit concept to you?</div><div class="review-meta"><span class="review-badge">Likert Scale</span><span class="review-badge">5 options</span><span class="review-badge">Required</span></div><div class="review-answers">Strongly Disagree → Strongly Agree</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">2</div><div class="review-content"><div class="review-text">How unique or different is this concept compared to others you've seen?</div><div class="review-meta"><span class="review-badge">Likert Scale</span><span class="review-badge">5 options</span></div><div class="review-answers">Not at all unique → Extremely unique</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">3</div><div class="review-content"><div class="review-text">How likely are you to purchase this meal kit service?</div><div class="review-meta"><span class="review-badge">Single Select</span><span class="review-badge">5 options</span></div><div class="review-answers">Definitely would → Definitely would not</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">4</div><div class="review-content"><div class="review-text">Which benefits are most appealing? Select all that apply.</div><div class="review-meta"><span class="review-badge">Multi Select</span><span class="review-badge">7 options</span></div><div class="review-answers">Convenience, Health, Sustainability, Variety, Price, Taste, Other</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">5</div><div class="review-content"><div class="review-text">What is the most you would pay per serving for this meal kit?</div><div class="review-meta"><span class="review-badge">Single Select</span><span class="review-badge">5 options</span></div><div class="review-answers">Under $5 · $5–$8 · $8–$12 · $12–$15 · Over $15</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">6</div><div class="review-content"><div class="review-text">Which concept do you prefer overall?</div><div class="review-meta"><span class="review-badge">Image Pick</span><span class="review-badge">3 options</span></div><div class="review-answers">Concept A · Concept B · No preference</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">7</div><div class="review-content"><div class="review-text">What improvements would make this product more appealing to you?</div><div class="review-meta"><span class="review-badge">Short Text</span><span class="review-badge">Open-ended</span></div><div class="review-answers">Free-text response</div></div><button class="review-btn">Edit</button></div>
          <div class="review-q"><div class="review-num">8</div><div class="review-content"><div class="review-text">Overall, how would you rate this concept on a scale of 0–10?</div><div class="review-meta"><span class="review-badge">Slider</span><span class="review-badge">0–10 scale</span></div><div class="review-answers">0 (Not at all likely) → 10 (Extremely likely)</div></div><button class="review-btn">Edit</button></div>
        </div>
      </div>
      <div class="review-sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">AUDIENCE</div>
          <div class="seg-dot-row"><div class="seg-dot" style="background:#111;"></div> Gen Z (18–25) · n=200</div>
          <div class="seg-dot-row"><div class="seg-dot" style="background:#666;"></div> Millennials (26–40) · n=200</div>
          <div class="seg-dot-row"><div class="seg-dot" style="background:#AAA;"></div> Gen X+ (41–60) · n=200</div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-title">SUMMARY</div>
          <div class="sidebar-row"><span class="lbl">Type</span><span class="val">Concept Testing</span></div>
          <div class="sidebar-row"><span class="lbl">Method</span><span class="val">Seq. Monadic</span></div>
          <div class="sidebar-row"><span class="lbl">Questions</span><span class="val">8</span></div>
          <div class="sidebar-row"><span class="lbl">Est. Time</span><span class="val">~4 min</span></div>
          <div class="sidebar-row"><span class="lbl">Segments</span><span class="val">3</span></div>
          <div class="sidebar-row"><span class="lbl">Sample</span><span class="val">600</span></div>
        </div>
        <div class="sidebar-section" style="background: var(--bg); border-left: 2px solid var(--black); border-radius: 0; border-top: none; border-right: none; border-bottom: none; padding: 12px 14px;">
          <div class="sidebar-title" style="margin-bottom: 8px;">AI REVIEW</div>
          <p style="font-size: 11px; color: var(--mid); line-height: 1.6; margin: 0;">Looks good. Two suggestions: (1) Move Q6 earlier so respondents compare while concepts are fresh. (2) Q7 open-ended may cause fatigue — consider making it optional.</p>
        </div>
      </div>
    </div>

    <div class="btn-row btn-row-wizard">
      <button class="btn btn-secondary" onclick="wizardNext(4)">← Edit Questions</button>
      <button class="btn btn-primary" onclick="wizardNext(6)">Launch Survey →</button>
    </div>
  </div>
</div>
</div>

<hr class="section-divider">

<!-- ==================== SECTION 6: RESULTS ==================== -->
<div class="wizard-screen" data-screen="results">
<div class="screen">
  <div class="section" id="sec-results">
    <div class="screen-step">RESULTS</div>
    <div class="results-header">
      <div>
        <h1 class="screen-title" style="margin-top:4px;">Plant-Based Meal Kit — Concept Test</h1>
        <p class="screen-sub" style="margin-bottom:0;">598 / 600 responses · Feb 10, 2026</p>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="results-tabs">
          <button class="results-tab active" onclick="selectTab(this)">Per Question</button>
          <button class="results-tab" onclick="selectTab(this)">Full Report</button>
          <button class="results-tab" onclick="selectTab(this)">Segments</button>
        </div>
        <button class="btn-edit-survey" onclick="editSurveyFromResults()">Edit survey</button>
      </div>
    </div>

    <div class="results-stream">
      <!-- Q1: Appeal -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">70%</div>
          <div class="finding-insight-text" contenteditable="false">Rate the concept as appealing or very appealing. Gen Z significantly higher at 78% vs Gen X+ at 62% (p &lt; 0.05). This is a strong signal for the younger demographic.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q1 · LIKERT SCALE</div>
          <div class="finding-text">How appealing is this concept?</div>
          <div class="finding-chart">
            <div class="chart-bar"><div class="chart-bar-val">4%</div><div class="chart-bar-fill" style="height:6px;background:#ddd;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">8%</div><div class="chart-bar-fill" style="height:12px;background:#ccc;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">18%</div><div class="chart-bar-fill" style="height:27px;background:#aaa;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">42%</div><div class="chart-bar-fill" style="height:63px;background:#444;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">28%</div><div class="chart-bar-fill" style="height:42px;background:#111;"></div></div>
          </div>
          <div class="chart-labels"><span>SD</span><span>D</span><span>N</span><span>A</span><span>SA</span></div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:78%;background:#111;"></div></div><div class="seg-bar-val">78%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:71%;background:#555;"></div></div><div class="seg-bar-val">71%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:62%;background:#aaa;"></div></div><div class="seg-bar-val">62%</div></div>
          </div>
        </div>
      </div>

      <!-- Q2: Uniqueness -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">54%</div>
          <div class="finding-insight-text" contenteditable="false">Consider the concept unique or very unique. Perception of uniqueness is weaker than appeal — a potential area for concept refinement, especially for older segments.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q2 · LIKERT SCALE</div>
          <div class="finding-text">How unique or different is this concept?</div>
          <div class="finding-chart">
            <div class="chart-bar"><div class="chart-bar-val">7%</div><div class="chart-bar-fill" style="height:10px;background:#ddd;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">14%</div><div class="chart-bar-fill" style="height:21px;background:#ccc;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">25%</div><div class="chart-bar-fill" style="height:37px;background:#aaa;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">34%</div><div class="chart-bar-fill" style="height:51px;background:#444;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">20%</div><div class="chart-bar-fill" style="height:30px;background:#111;"></div></div>
          </div>
          <div class="chart-labels"><span>Not at all</span><span>Slightly</span><span>Moderate</span><span>Very</span><span>Extremely</span></div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:61%;background:#111;"></div></div><div class="seg-bar-val">61%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:55%;background:#555;"></div></div><div class="seg-bar-val">55%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:46%;background:#aaa;"></div></div><div class="seg-bar-val">46%</div></div>
          </div>
        </div>
      </div>

      <!-- Q3: Purchase Intent -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">60%</div>
          <div class="finding-insight-text" contenteditable="false">Top-2 box purchase intent. Millennials highest at 67% — the most promising conversion segment. Consider targeting marketing spend here first.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q3 · SINGLE SELECT</div>
          <div class="finding-text">How likely are you to purchase this meal kit service?</div>
          <div class="finding-chart">
            <div class="chart-bar"><div class="chart-bar-val">6%</div><div class="chart-bar-fill" style="height:9px;background:#ddd;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">12%</div><div class="chart-bar-fill" style="height:18px;background:#ccc;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">22%</div><div class="chart-bar-fill" style="height:33px;background:#aaa;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">38%</div><div class="chart-bar-fill" style="height:57px;background:#444;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">22%</div><div class="chart-bar-fill" style="height:33px;background:#111;"></div></div>
          </div>
          <div class="chart-labels"><span>Def. not</span><span>Prob. not</span><span>Maybe</span><span>Probably</span><span>Definitely</span></div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:58%;background:#111;"></div></div><div class="seg-bar-val">58%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:67%;background:#555;"></div></div><div class="seg-bar-val">67%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:54%;background:#aaa;"></div></div><div class="seg-bar-val">54%</div></div>
          </div>
        </div>
      </div>

      <!-- Q4: Benefits -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">71%</div>
          <div class="finding-insight-text" contenteditable="false">Convenience is the top benefit, followed by Health (64%). Gen Z over-indexes on Sustainability (68% vs 41% Gen X+). Lead with convenience in broad messaging; sustainability for younger segments.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q4 · MULTI SELECT</div>
          <div class="finding-text">Which benefits are most appealing? Select all that apply.</div>
          <div class="finding-chart">
            <div class="chart-bar"><div class="chart-bar-val">71%</div><div class="chart-bar-fill" style="height:71px;background:#111;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">64%</div><div class="chart-bar-fill" style="height:64px;background:#333;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">52%</div><div class="chart-bar-fill" style="height:52px;background:#555;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">45%</div><div class="chart-bar-fill" style="height:45px;background:#999;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">31%</div><div class="chart-bar-fill" style="height:31px;background:#ccc;"></div></div>
          </div>
          <div class="chart-labels"><span>Conv.</span><span>Health</span><span>Sustain.</span><span>Variety</span><span>Price</span></div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:68%;background:#111;"></div></div><div class="seg-bar-val">68%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:74%;background:#555;"></div></div><div class="seg-bar-val">74%</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:70%;background:#aaa;"></div></div><div class="seg-bar-val">70%</div></div>
          </div>
        </div>
      </div>

      <!-- Q5: Willingness to Pay -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">&pound;8.50</div>
          <div class="finding-insight-text" contenteditable="false">Median willingness to pay per meal. Millennials willing to pay more (&pound;9.20) than Gen X+ (&pound;7.80). Price sensitivity is a barrier for older segments — consider a tiered pricing model.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q5 · SINGLE SELECT</div>
          <div class="finding-text">How much would you be willing to pay per meal?</div>
          <div class="finding-chart">
            <div class="chart-bar"><div class="chart-bar-val">8%</div><div class="chart-bar-fill" style="height:12px;background:#ddd;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">16%</div><div class="chart-bar-fill" style="height:24px;background:#ccc;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">35%</div><div class="chart-bar-fill" style="height:52px;background:#444;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">28%</div><div class="chart-bar-fill" style="height:42px;background:#333;"></div></div>
            <div class="chart-bar"><div class="chart-bar-val">13%</div><div class="chart-bar-fill" style="height:19px;background:#111;"></div></div>
          </div>
          <div class="chart-labels"><span>&lt;&pound;5</span><span>&pound;5–7</span><span>&pound;7–9</span><span>&pound;9–12</span><span>&pound;12+</span></div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:65%;background:#111;"></div></div><div class="seg-bar-val">&pound;8.40</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:73%;background:#555;"></div></div><div class="seg-bar-val">&pound;9.20</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:52%;background:#aaa;"></div></div><div class="seg-bar-val">&pound;7.80</div></div>
          </div>
        </div>
      </div>

      <!-- Q6: Concept Preference -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">58 / 42</div>
          <div class="finding-insight-text" contenteditable="false">Concept A wins overall. But Gen Z prefers Concept B (52%), driven by bolder sustainability messaging. Consider A as the lead concept with B elements for youth-targeted variants.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q6 · IMAGE PICK</div>
          <div class="finding-text">Concept preference</div>
          <div class="concept-compare">
            <div class="concept-option winner"><div class="concept-pct">58%</div><div class="concept-name">Concept A — "Fresh & Green"</div></div>
            <div class="concept-option"><div class="concept-pct" style="color:var(--light);">42%</div><div class="concept-name">Concept B — "Plant Power"</div></div>
          </div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:48%;background:#111;"></div></div><div class="seg-bar-val">48% A</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:62%;background:#555;"></div></div><div class="seg-bar-val">62% A</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:64%;background:#aaa;"></div></div><div class="seg-bar-val">64% A</div></div>
          </div>
        </div>
      </div>

      <!-- Q7: Improvement Ideas (Open-Ended) -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">3 themes</div>
          <div class="finding-insight-text" contenteditable="false">Open-ended responses cluster into three themes: (1) more recipe variety, (2) family-size portions, and (3) allergen-friendly options. These are clear product development inputs.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q7 · OPEN TEXT</div>
          <div class="finding-text">What would improve this concept for you?</div>
          <div style="padding:16px;background:var(--off);border:1px solid var(--rule);margin-bottom:12px;">
            <div style="font-size:10px;font-weight:600;letter-spacing:0.08em;color:var(--light);margin-bottom:10px;">TOP THEMES (AI-EXTRACTED)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <span style="padding:6px 14px;border:1px solid var(--rule);font-size:12px;font-weight:500;">More recipes <span style="color:var(--light);margin-left:4px;">38%</span></span>
              <span style="padding:6px 14px;border:1px solid var(--rule);font-size:12px;font-weight:500;">Family portions <span style="color:var(--light);margin-left:4px;">24%</span></span>
              <span style="padding:6px 14px;border:1px solid var(--rule);font-size:12px;font-weight:500;">Allergen options <span style="color:var(--light);margin-left:4px;">19%</span></span>
              <span style="padding:6px 14px;border:1px solid var(--rule);font-size:12px;font-weight:500;">Lower price <span style="color:var(--light);margin-left:4px;">12%</span></span>
            </div>
          </div>
          <div style="font-size:11px;color:var(--light);cursor:pointer;">View 598 individual responses →</div>
        </div>
      </div>

      <!-- Q8: Overall Feedback -->
      <div class="finding-row">
        <div class="finding-insight-col">
          <div class="finding-insight-label"><span>FINDING</span><span class="edit-icon" onclick="toggleEdit(this)">Edit</span></div>
          <div class="insight-stat">7.4 / 10</div>
          <div class="finding-insight-text" contenteditable="false">Overall concept score. Strong performance above the 7.0 benchmark. Concept A scores higher (7.8) than B (6.9). Ready for next-stage development with refinements from open-ended feedback.</div>
          <div class="insight-note">AI-generated — click Edit to refine</div>
        </div>
        <div class="finding-data-col">
          <div class="finding-q">Q8 · SLIDER (0–10)</div>
          <div class="finding-text">Overall, how would you rate this concept?</div>
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
            <div style="font-family:'Playfair Display',Georgia,serif;font-size:48px;font-weight:700;">7.4</div>
            <div style="font-size:13px;color:var(--mid);line-height:1.6;">out of 10<br>598 responses</div>
          </div>
          <div class="finding-segment-bars">
            <div class="seg-bar-row"><div class="seg-bar-label">Gen Z</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:76%;background:#111;"></div></div><div class="seg-bar-val">7.6</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Millennials</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:78%;background:#555;"></div></div><div class="seg-bar-val">7.8</div></div>
            <div class="seg-bar-row"><div class="seg-bar-label">Gen X+</div><div class="seg-bar-track"><div class="seg-bar-fill" style="width:68%;background:#aaa;"></div></div><div class="seg-bar-val">6.8</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Stimulus lightbox -->
<div class="stim-lightbox" id="stim-lightbox" onclick="if(event.target===this)closeStimLightbox()">
  <div class="stim-lightbox-inner">
    <button class="stim-lightbox-close" onclick="closeStimLightbox()">×</button>
    <div class="stim-preview-label" style="margin-bottom:16px;">STIMULUS PREVIEW — WHAT RESPONDENTS SEE</div>
    <div style="display:flex;gap:20px;">
      <div class="stim-full-card active-concept" style="flex:1;border:1px solid var(--rule);overflow:hidden;">
        <div class="stim-full-img"><div class="placeholder-inner"><div class="placeholder-icon">🥗</div><div class="placeholder-text">Plant-based meal kit — Concept A</div></div></div>
        <div class="stim-full-meta"><span class="stim-preview-name">Concept A</span><span class="stim-preview-badge">Showing</span></div>
      </div>
      <div class="stim-full-card" style="flex:1;border:1px solid var(--rule);overflow:hidden;">
        <div class="stim-full-img"><div class="placeholder-inner"><div class="placeholder-icon">🍲</div><div class="placeholder-text">Plant-based meal kit — Concept B</div></div></div>
        <div class="stim-full-meta"><span class="stim-preview-name">Concept B</span><span class="stim-preview-badge">Next</span></div>
      </div>
    </div>
  </div>
</div>

<div style="height:80px;"></div>

<script>
  // State
  let currentStep = 1;
  let mode = 'page-builder';
  const completedSteps = new Set();

  // DEV_MODE: unlock all sidebar steps for debugging.
  // Set to false before demoing to stakeholders.
  let DEV_MODE = false;
  let selectedBuildMethod = 'ai'; // 'ai', 'manual', or 'template'
  let editingStimulus = false; // true when stimulus config is shown in editor
  let manualStimuli = []; // [{name, meta, icon}] for manual mode stimulus items

  // Stimulus lightbox
  function openStimLightbox() {
    document.getElementById('stim-lightbox').classList.add('open');
  }
  function closeStimLightbox() {
    document.getElementById('stim-lightbox').classList.remove('open');
  }

  // Floating prototype settings
  function toggleProtoSettings() {
    document.getElementById('proto-settings-trigger').classList.toggle('open');
    document.getElementById('proto-settings-panel').classList.toggle('open');
  }

  function toggleDevMode(on) {
    DEV_MODE = on;
    updatePbSidebar();
  }

  // ===== FLOW CONFIGURATION =====
  // Type → determines which steps appear
  const typeConfig = {
    simple:   { needsStimulus: false, label: 'Simple Survey' },
    concept:  { needsStimulus: true,  label: 'Concept Testing' },
    message:  { needsStimulus: true,  label: 'Message Testing' },
    creative: { needsStimulus: true,  label: 'Creative Testing' },
    brand:    { needsStimulus: false, label: 'Brand Tracking' },
    audience: { needsStimulus: false, label: 'Audience Exploration' },
  };

  const audienceHeaders = {
    simple:   { title: 'Who should take this survey?', sub: 'Define your target respondents.' },
    concept:  { title: 'Who will evaluate these concepts?', sub: 'Choose the audience who will see and rate your concepts.' },
    message:  { title: 'Who will see these messages?', sub: 'Select the audience for your message test.' },
    creative: { title: 'Who will see this creative?', sub: 'Choose the audience for your creative evaluation.' },
    brand:    { title: 'Whose brand perception are you tracking?', sub: 'Define the population you want to measure.' },
    audience: { title: 'Who do you want to understand?', sub: 'Define the group you want to explore and profile.' },
  };

  const stimulusHeaders = {
    concept:  { title: 'Add your concepts', sub: 'Upload the concepts respondents will evaluate.' },
    message:  { title: 'Add your messages', sub: 'Upload the messages or taglines to test.' },
    creative: { title: 'Add your creative', sub: 'Upload the ads, packaging, or visuals to evaluate.' },
  };

  // flowSteps: the active steps for the current type
  // Default (before type is selected): just 'type'
  let flowSteps = ['type'];
  let selectedType = null;

  function rebuildFlow(typeName) {
    selectedType = typeName;
    const config = typeConfig[typeName];
    if (!config) return;
    flowSteps = ['type', 'audience'];
    if (config.needsStimulus) flowSteps.push('stimulus');
    flowSteps.push('questions', 'preview');
    renderSidebar();
    updateStepLabels();
    updateAudienceHeaders(typeName);
    if (config.needsStimulus) updateStimulusHeaders(typeName);
  }

  function stepIndexOf(name) {
    return flowSteps.indexOf(name) + 1; // 1-indexed
  }

  function stepNameOf(n) {
    return flowSteps[n - 1] || null;
  }

  function totalStepCount() {
    return flowSteps.length;
  }

  function renderSidebar() {
    const sidebar = document.getElementById('pb-sidebar');
    const labels = {
      type: 'Type',
      audience: 'Audience',
      stimulus: 'Stimulus',
      questions: 'Questions',
      preview: 'Preview',
    };
    let html = '<div class="pb-sidebar-title">SURVEY BUILDER</div>';
    flowSteps.forEach((name, i) => {
      const n = i + 1;
      html += `<div class="pb-item${n === currentStep ? ' active' : (completedSteps.has(n) ? ' done' : (n > currentStep && !DEV_MODE ? ' locked' : ''))}" data-pb="${n}" onclick="pbNav(${n})">
        <div class="pb-dot"><span>${n}</span></div>
        <div class="pb-label">${labels[name] || name}</div>
        <div class="pb-status">${n === currentStep ? 'In progress' : (completedSteps.has(n) ? 'Done' : '')}</div>
        <div class="pb-spinner"></div>
      </div>`;
    });
    sidebar.innerHTML = html;
  }

  function updateStepLabels() {
    // Update step number labels on screens
    const typeIdx = stepIndexOf('type');
    const audIdx = stepIndexOf('audience');
    const stimIdx = stepIndexOf('stimulus');
    const qIdx = stepIndexOf('questions');
    const prevIdx = stepIndexOf('preview');

    const audLabel = document.getElementById('audience-step-label');
    if (audLabel) audLabel.textContent = (audIdx < 10 ? '0' : '') + audIdx + ' — AUDIENCE';

    const stimLabel = document.getElementById('stimulus-step-label');
    if (stimLabel && stimIdx > 0) stimLabel.textContent = (stimIdx < 10 ? '0' : '') + stimIdx + ' — STIMULUS';

    const qLabel = document.getElementById('questions-step-label');
    if (qLabel && qIdx > 0) qLabel.textContent = (qIdx < 10 ? '0' : '') + qIdx + ' — QUESTIONS';

    const edLabel = document.getElementById('editor-step-label');
    if (edLabel && qIdx > 0) edLabel.textContent = (qIdx < 10 ? '0' : '') + qIdx + ' — QUESTIONS';

    const prevLabel = document.getElementById('preview-step-label');
    if (prevLabel && prevIdx > 0) prevLabel.textContent = (prevIdx < 10 ? '0' : '') + prevIdx + ' — PREVIEW';
  }

  function updateAudienceHeaders(typeName) {
    const h = audienceHeaders[typeName] || audienceHeaders.simple;
    const titleEl = document.getElementById('audience-title');
    const subEl = document.querySelector('#sec-audience .screen-sub');
    if (titleEl) titleEl.textContent = h.title;
    if (subEl) subEl.textContent = h.sub;
  }

  function updateStimulusHeaders(typeName) {
    const h = stimulusHeaders[typeName];
    if (!h) return;
    const titleEl = document.getElementById('stimulus-title');
    const subEl = document.getElementById('stimulus-sub');
    if (titleEl) titleEl.textContent = h.title;
    if (subEl) subEl.textContent = h.sub;
  }

  // Mode switching
  function setMode(m) {
    mode = m;
    document.body.className = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`.mode-btn`).forEach(b => { if (b.getAttribute('onclick') === `setMode('${m}')`) b.classList.add('active'); });

    // Auto-close settings panel on mode switch
    document.getElementById('proto-settings-panel').classList.remove('open');
    document.getElementById('proto-settings-trigger').classList.remove('open');

    if (m !== 'page-builder') hidePbConfirm();
    if (m === 'page-builder') {
      clearDefaults();
      currentStep = 1;
      buildPhase = 'form';
      selectedBuildMethod = 'ai';
      editingStimulus = false;
      manualStimuli = [];
      selectedType = null;
      flowSteps = ['type'];
      // Restore original question data if it was modified
      questionData.length = 0;
      questionData.push(...JSON.parse(JSON.stringify(originalQuestionData)));
      renderSidebar();
      pbActivate(1);
    } else if (m === 'single-page') {
      applyDefaults();
      currentStep = 1;
      updateProgressiveLock();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      applyDefaults();
      currentStep = 1;
      wizardNext(1);
    }
  }

  function updateProgressiveLock() {
    // In single-page mode, sections unlock as previous ones are completed
    const sections = [
      { id: 'sec-build', step: 1, needs: [] },
      { id: 'sec-type', step: 2, needs: [1] },
      { id: 'sec-audience', step: 3, needs: [1, 2] },
      { id: 'sec-editor', step: 4, needs: [1, 2, 3] },
      { id: 'sec-review', step: 5, needs: [1, 2, 3, 4] },
      { id: 'sec-results', step: 6, needs: [1, 2, 3, 4, 5] },
    ];

    sections.forEach(s => {
      const el = document.getElementById(s.id);
      const unlocked = s.needs.every(n => completedSteps.has(n));
      el.classList.toggle('locked', !unlocked);
    });
  }

  function completeStep(n) {
    completedSteps.add(n);
    if (mode === 'single-page') updateProgressiveLock();
    if (mode === 'page-builder') updatePbSidebar();
  }

  // Wizard navigation
  function wizardNext(n) {
    currentStep = n;
    // Mark previous steps as done
    for (let i = 1; i < n; i++) completeStep(i);

    if (mode === 'wizard') {
      document.querySelectorAll('.wizard-screen').forEach(s => s.classList.remove('wizard-active'));
      const target = document.querySelector(`.wizard-screen[data-screen="${n}"]`);
      if (target) target.classList.add('wizard-active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (mode === 'page-builder') {
      pbActivate(n);
    } else {
      // Single page: scroll to section
      const sectionIds = ['sec-build', 'sec-type', 'sec-audience', 'sec-editor', 'sec-review', 'sec-results'];
      const el = document.getElementById(sectionIds[n - 1]);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    updateNav(n);
  }

  function updateNav(active) {
    document.querySelectorAll('.nav-step').forEach(s => {
      const step = parseInt(s.dataset.step);
      s.classList.remove('active', 'done');
      if (step === active) s.classList.add('active');
      else if (step < active) s.classList.add('done');
    });
  }

  // Survey type selection
  function selectType(el) {
    document.querySelectorAll('#type-grid .type-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const typeName = el.dataset.type;
    rebuildFlow(typeName);
    if (mode === 'page-builder') {
      showPbConfirm(stepIndexOf('type'), el.querySelector('h3').textContent);
    } else {
      completeStep(stepIndexOf('type'));
    }
  }

  // Audience selection
  function selectAudience(el) {
    document.querySelectorAll('#aud-options .aud-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const aud = el.dataset.aud;
    document.getElementById('multi-panel').classList.toggle('hidden', aud !== 'multi');
    document.getElementById('single-panel').classList.toggle('hidden', aud !== 'single');
    // Clear any previous audience pick
    document.querySelectorAll('.aud-suggestion').forEach(s => s.classList.remove('picked'));
    // Don't complete step yet — user still needs to pick an actual audience
  }

  function pickAudience(el, value) {
    document.querySelectorAll('.aud-suggestion').forEach(s => s.classList.remove('picked'));
    if (el) el.classList.add('picked');
    if (mode === 'page-builder') {
      const label = el ? el.querySelector('.aud-sug-name').textContent : 'Custom audience';
      showPbConfirm(stepIndexOf('audience'), label);
    } else {
      completeStep(stepIndexOf('audience'));
    }
  }

  // Build method
  function selectBuild(el) {
    document.querySelectorAll('#build-grid .build-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const method = el.dataset.build;
    selectedBuildMethod = method;

    // Deselect any selected template
    document.querySelectorAll('.template-option.selected').forEach(t => t.classList.remove('selected'));

    // Hide template section when a build card is chosen
    const tplSection = document.getElementById('template-section');
    if (tplSection) tplSection.style.display = 'none';

    if (mode === 'page-builder') {
      if (method === 'manual') {
        document.querySelectorAll('.build-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-manual').classList.add('active');
        showPbConfirm(stepIndexOf('questions'), 'Build From Scratch');
      } else if (method === 'ai') {
        document.querySelectorAll('.build-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-ai').classList.add('active');
        checkBuildReady();
      }
    } else {
      document.querySelectorAll('.build-panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById('panel-' + method);
      if (panel) panel.classList.add('active');
      completeStep(stepIndexOf('questions'));
    }
  }

  // Template selection
  function selectTemplate(el, name) {
    document.querySelectorAll('#build-grid .build-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.build-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.template-option').forEach(t => t.classList.remove('selected'));
    el.classList.add('selected');
    selectedBuildMethod = 'template';
    if (mode === 'page-builder') {
      showPbConfirm(stepIndexOf('questions'), name);
    } else {
      completeStep(stepIndexOf('questions'));
    }
  }

  // Question type dropdown
  function toggleTypeDropdown() {
    const trigger = document.getElementById('q-type-trigger');
    const dropdown = document.getElementById('q-type-dropdown');
    const isOpen = dropdown.classList.contains('open');
    if (isOpen) {
      dropdown.classList.remove('open');
      trigger.classList.remove('open');
    } else {
      dropdown.classList.add('open');
      trigger.classList.add('open');
    }
  }
  function selectQuestionType(el, icon, name) {
    const trigger = document.getElementById('q-type-trigger');
    const dropdown = document.getElementById('q-type-dropdown');
    trigger.querySelector('.qt-icon').textContent = icon;
    trigger.querySelector('.qt-label').textContent = name;
    dropdown.querySelectorAll('.q-type-dropdown-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
    dropdown.classList.remove('open');
    trigger.classList.remove('open');

    // Update question data model
    if (activeQuestion >= 0 && activeQuestion < questionData.length) {
      const q = questionData[activeQuestion];
      const oldType = q.type;
      q.type = name;
      q.icon = icon;
      // Reset answers to defaults for new type (if type actually changed)
      if (oldType !== name) {
        q.answers = getDefaultAnswersForType(name);
        renderAnswersForQuestion(activeQuestion);
        // Show/hide add option button
        const addOptionBtn = document.querySelector('#q-editor-content .add-option');
        if (addOptionBtn) {
          addOptionBtn.style.display = (name === 'Short Text' || name === 'Slider') ? 'none' : '';
        }
      }
      // Update sidebar badge
      renderQuestionList();
    }
  }
  // Close dropdown on outside click
  document.addEventListener('click', function(e) {
    const trigger = document.getElementById('q-type-trigger');
    const dropdown = document.getElementById('q-type-dropdown');
    if (trigger && dropdown && !trigger.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove('open');
      trigger.classList.remove('open');
    }
  });

  // Question data model
  const questionData = [
    { title: 'How appealing is this meal kit concept to you?', type: 'Likert Scale', icon: '≡',
      answers: ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'],
      ai: 'Good opening question. 5-point agreement scale captures overall sentiment before drilling into specifics.' },
    { title: 'How unique or different is this concept compared to others you\'ve seen?', type: 'Likert Scale', icon: '≡',
      answers: ['Not at all unique', 'Slightly unique', 'Moderately unique', 'Very unique', 'Extremely unique'],
      ai: 'Uniqueness perception helps gauge differentiation. Place early while first impressions are fresh.' },
    { title: 'How likely are you to purchase this meal kit service?', type: 'Single Select', icon: '◉',
      answers: ['Definitely would purchase', 'Probably would purchase', 'Might or might not purchase', 'Probably would not purchase', 'Definitely would not purchase'],
      ai: 'Standard 5-point purchase intent scale. Consider adding "Not sure / need more info" for undecided respondents.' },
    { title: 'Which benefits are most appealing? Select all that apply.', type: 'Multi Select', icon: '☑',
      answers: ['Convenience', 'Health benefits', 'Sustainability', 'Variety of meals', 'Affordable price', 'Great taste', 'Other'],
      ai: 'Multi-select captures the full picture of value drivers. "Other" lets respondents flag benefits we missed.' },
    { title: 'What is the most you would pay per serving for this meal kit?', type: 'Single Select', icon: '◉',
      answers: ['Under $5', '$5–$8', '$8–$12', '$12–$15', 'Over $15'],
      ai: 'Price sensitivity brackets are even. Consider Van Westendorp for deeper pricing analysis in follow-up.' },
    { title: 'Which concept do you prefer overall?', type: 'Image Pick', icon: '▣',
      answers: ['Concept A', 'Concept B', 'No preference'],
      ai: 'Direct comparison. Position after individual evaluation to avoid anchoring. "No preference" reduces forced choice bias.' },
    { title: 'What improvements would make this product more appealing to you?', type: 'Short Text', icon: '¶',
      answers: [],
      ai: 'Open-ended captures unanticipated insights. Place near end to avoid fatigue on earlier questions. Consider making optional.' },
    { title: 'Overall, how would you rate this concept on a scale of 0–10?', type: 'Slider', icon: '⟷',
      answers: ['0 — Not at all likely to recommend', '10 — Extremely likely to recommend'],
      ai: 'NPS-style rating provides a single summary metric. Good for cross-concept and cross-segment benchmarking.' },
  ];
  let activeQuestion = 2; // 0-indexed, starts on Q3

  function selectQuestion(idx) {
    if (idx === activeQuestion && !editingStimulus) return;
    if (idx < 0 || idx >= questionData.length) return;
    activeQuestion = idx;
    const q = questionData[idx];

    // Update list active state
    document.querySelectorAll('#q-list-panel .q-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`.q-item[data-qi="${idx}"]`);
    if (activeItem) activeItem.classList.add('active');

    // If we were on stimulus tab, switch back to questions tab
    if (editingStimulus) {
      switchEditorTab('questions');
    }

    // Restore editor content if it was showing empty state
    const editorContent = document.getElementById('q-editor-content');
    if (editorContent && editorContent.querySelector('.q-editor-empty')) {
      // Rebuild the full editor UI
      editorContent.innerHTML = `
        <div class="q-editor-header">
          <span class="q-editor-label" id="q-editor-label"></span>
          <div style="display:flex;align-items:center;">
            <div style="position:relative;">
              <button class="q-type-trigger" id="q-type-trigger" onclick="toggleTypeDropdown()">
                <span class="qt-icon">◉</span>
                <span class="qt-label">Single Select</span>
                <span class="qt-arrow">▾</span>
              </button>
              <div class="q-type-dropdown" id="q-type-dropdown">
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '◉', 'Single Select')"><span class="qtd-icon">◉</span><div class="qtd-info"><div class="qtd-name">Single Select</div><div class="qtd-desc">Pick one answer</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '☑', 'Multi Select')"><span class="qtd-icon">☑</span><div class="qtd-info"><div class="qtd-name">Multi Select</div><div class="qtd-desc">Pick multiple answers</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '≡', 'Likert Scale')"><span class="qtd-icon">≡</span><div class="qtd-info"><div class="qtd-name">Likert Scale</div><div class="qtd-desc">Agreement or frequency scale</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '★', 'Rating')"><span class="qtd-icon">★</span><div class="qtd-info"><div class="qtd-name">Rating</div><div class="qtd-desc">Star or number rating</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '▣', 'Image Pick')"><span class="qtd-icon">▣</span><div class="qtd-info"><div class="qtd-name">Image Pick</div><div class="qtd-desc">Choose from images</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '⇅', 'Rank Order')"><span class="qtd-icon">⇅</span><div class="qtd-info"><div class="qtd-name">Rank Order</div><div class="qtd-desc">Drag to rank preferences</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '¶', 'Short Text')"><span class="qtd-icon">¶</span><div class="qtd-info"><div class="qtd-name">Short Text</div><div class="qtd-desc">Open-ended response</div></div></div>
                <div class="q-type-dropdown-item" onclick="selectQuestionType(this, '⟷', 'Slider')"><span class="qtd-icon">⟷</span><div class="qtd-info"><div class="qtd-name">Slider</div><div class="qtd-desc">Drag along a scale</div></div></div>
              </div>
            </div>
            <button class="q-delete-btn" onclick="deleteQuestion(${idx})">Delete</button>
          </div>
        </div>
        <input class="q-input" id="q-input" value="" placeholder="Type your question here…" oninput="updateQuestionTitle(this.value)">
        <div class="answers-label">ANSWER OPTIONS</div>
        <div id="q-answers"></div>
        <button class="add-option" onclick="addAnswerOption()">+ Add option</button>
        <div class="q-settings-row">
          <div class="q-setting"><div class="toggle-track" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></div><span>Required</span></div>
          <div class="q-setting"><div class="toggle-track" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></div><span>Randomise options</span></div>
        </div>
        <div class="ai-box" id="q-ai-box"><div class="ai-label">AI SUGGESTION</div><p id="q-ai-text"></p></div>`;
    }

    // Update editor header
    document.getElementById('q-editor-label').textContent = `Question ${idx + 1} of ${questionData.length}`;

    // Update delete button index
    const deleteBtn = editorContent.querySelector('.q-delete-btn');
    if (deleteBtn) deleteBtn.setAttribute('onclick', `deleteQuestion(${idx})`);

    // Update type trigger
    const trigger = document.getElementById('q-type-trigger');
    trigger.querySelector('.qt-icon').textContent = q.icon;
    trigger.querySelector('.qt-label').textContent = q.type;

    // Update type dropdown selected state
    document.querySelectorAll('.q-type-dropdown-item').forEach(item => {
      item.classList.toggle('selected', item.querySelector('.qtd-name').textContent === q.type);
    });

    // Update question text
    const qInput = document.getElementById('q-input');
    qInput.value = q.title;
    qInput.setAttribute('oninput', 'updateQuestionTitle(this.value)');

    // Update answers using the shared render function
    renderAnswersForQuestion(idx);

    // Show/hide add option button based on type
    const addOptionBtn = editorContent.querySelector('.add-option');
    if (addOptionBtn) {
      addOptionBtn.style.display = (q.type === 'Short Text' || q.type === 'Slider') ? 'none' : '';
      addOptionBtn.setAttribute('onclick', 'addAnswerOption()');
    }

    // Update AI suggestion — hide if no AI suggestion
    const aiBox = document.getElementById('q-ai-box');
    const aiText = document.getElementById('q-ai-text');
    if (aiBox && aiText) {
      if (q.ai) {
        aiText.textContent = q.ai;
        aiBox.style.display = '';
      } else {
        aiBox.style.display = 'none';
      }
    }
  }

  // ===== MANUAL QUESTION CREATION FUNCTIONS =====

  // Store original AI-generated questions for when we switch back from manual
  const originalQuestionData = JSON.parse(JSON.stringify(questionData));

  function getDefaultAnswersForType(type) {
    switch (type) {
      case 'Single Select': return ['Option 1', 'Option 2', 'Option 3'];
      case 'Multi Select': return ['Option 1', 'Option 2', 'Option 3'];
      case 'Likert Scale': return ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
      case 'Rating': return ['1', '2', '3', '4', '5'];
      case 'Image Pick': return ['Image 1', 'Image 2'];
      case 'Rank Order': return ['Item 1', 'Item 2', 'Item 3'];
      case 'Short Text': return [];
      case 'Slider': return ['0', '10'];
      default: return ['Option 1', 'Option 2', 'Option 3'];
    }
  }

  function getTypeIcon(type) {
    const icons = {
      'Single Select': '◉', 'Multi Select': '☑', 'Likert Scale': '≡',
      'Rating': '★', 'Image Pick': '▣', 'Rank Order': '⇅',
      'Short Text': '¶', 'Slider': '⟷'
    };
    return icons[type] || '◉';
  }

  function getTypeBadge(type) {
    const badges = {
      'Single Select': 'Single', 'Multi Select': 'Multi', 'Likert Scale': 'Likert',
      'Rating': 'Rating', 'Image Pick': 'Image', 'Rank Order': 'Rank',
      'Short Text': 'Text', 'Slider': 'Slider'
    };
    return badges[type] || 'Single';
  }

  let dragSrcIndex = null;

  function renderQuestionList() {
    const panel = document.getElementById('q-list-panel');
    if (!panel) return;

    let html = `<div class="q-list-header">QUESTIONS (${questionData.length})</div>`;

    questionData.forEach((q, i) => {
      const isActive = i === activeQuestion ? ' active' : '';
      const shortTitle = q.title || 'Untitled question';
      const displayTitle = shortTitle.length > 22 ? shortTitle.substring(0, 22) + '…' : shortTitle;
      html += `<div class="q-item${isActive}" data-qi="${i}" draggable="true" onclick="selectQuestion(${i})" ondragstart="qDragStart(event, ${i})" ondragover="qDragOver(event)" ondragenter="qDragEnter(event)" ondragleave="qDragLeave(event)" ondrop="qDrop(event, ${i})" ondragend="qDragEnd(event)"><span class="q-drag-handle">⋮⋮</span><span class="q-num">${i + 1}</span> ${displayTitle} <span class="q-type-badge">${getTypeBadge(q.type)}</span></div>`;
    });

    html += `<button class="add-q-btn" onclick="addQuestion()">+ Add Question</button>`;
    panel.innerHTML = html;

    // Update tab count
    const tabCount = document.getElementById('tab-q-count');
    if (tabCount) tabCount.textContent = questionData.length;
  }

  function qDragStart(e, idx) {
    dragSrcIndex = idx;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', idx);
  }

  function qDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }

  function qDragEnter(e) {
    e.preventDefault();
    const item = e.target.closest('.q-item');
    if (item) item.classList.add('drag-over');
  }

  function qDragLeave(e) {
    const item = e.target.closest('.q-item');
    if (item) item.classList.remove('drag-over');
  }

  function qDrop(e, targetIdx) {
    e.preventDefault();
    const item = e.target.closest('.q-item');
    if (item) item.classList.remove('drag-over');
    if (dragSrcIndex === null || dragSrcIndex === targetIdx) return;

    // Reorder questionData
    const moved = questionData.splice(dragSrcIndex, 1)[0];
    questionData.splice(targetIdx, 0, moved);

    // Update active question to follow the moved item
    if (activeQuestion === dragSrcIndex) {
      activeQuestion = targetIdx;
    } else if (dragSrcIndex < activeQuestion && targetIdx >= activeQuestion) {
      activeQuestion--;
    } else if (dragSrcIndex > activeQuestion && targetIdx <= activeQuestion) {
      activeQuestion++;
    }

    renderQuestionList();
    dragSrcIndex = null;
  }

  function qDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.q-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragSrcIndex = null;
  }

  // ===== EDITOR TABS (Questions / Stimulus) =====

  function switchEditorTab(tab) {
    // Update tab active states
    document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector(`.editor-tab[data-editor-tab="${tab}"]`);
    if (activeTab) activeTab.classList.add('active');

    const builderLayout = document.getElementById('builder-layout');
    const stimContent = document.getElementById('stim-tab-content');

    if (tab === 'stimulus') {
      editingStimulus = true;
      if (builderLayout) builderLayout.style.display = 'none';
      if (stimContent) stimContent.style.display = 'block';
      renderStimulusTab();
    } else {
      editingStimulus = false;
      if (builderLayout) builderLayout.style.display = '';
      if (stimContent) stimContent.style.display = 'none';
    }
  }

  function showEditorTabs() {
    const tabs = document.getElementById('editor-tabs');
    if (tabs) tabs.style.display = '';
  }

  function hideEditorTabs() {
    const tabs = document.getElementById('editor-tabs');
    if (tabs) tabs.style.display = 'none';
  }

  function renderStimulusTab() {
    const container = document.getElementById('stim-tab-content');
    if (!container) return;

    let conceptsHtml = '';
    if (manualStimuli.length > 0) {
      conceptsHtml = '<div class="stim-concept-list">';
      manualStimuli.forEach((s, i) => {
        conceptsHtml += `<div class="stim-concept-card">
          <div class="stim-concept-thumb">${s.icon}</div>
          <div class="stim-concept-info">
            <div class="stim-concept-name">${s.name}</div>
            <div class="stim-concept-meta">${s.meta}</div>
          </div>
          <button class="stim-concept-remove" onclick="removeManualStim(${i})" title="Remove">×</button>
        </div>`;
      });
      conceptsHtml += '</div>';
      conceptsHtml += `<div class="stim-config-upload" onclick="simulateManualStimUpload()" style="padding:16px;margin-top:12px;">
        <div class="upload-text">+ Add another stimulus</div>
      </div>`;
    } else {
      conceptsHtml = `<div class="stim-config-upload" onclick="simulateManualStimUpload()">
        <div class="upload-icon">⬆</div>
        <div class="upload-text">Drop files here or click to browse</div>
        <div class="upload-hint">Images, videos, PDFs, or text — up to 5 items</div>
      </div>`;
    }

    container.innerHTML = `
      <div class="stim-config">
        <div class="stim-config-title">Stimulus materials</div>
        <div class="stim-config-sub">Upload the concepts, ads, images, or videos respondents will see before answering your questions. This is optional — leave empty if your survey doesn't require stimulus.</div>
        ${conceptsHtml}
        <div class="stim-config-note">Stimulus is shown to all respondents at the start of the survey. If you add multiple items, respondents will see them in sequence (monadic design) or side-by-side, depending on survey type.</div>
      </div>`;

    // Update tab badge
    const badge = document.getElementById('tab-stim-count');
    if (badge) badge.textContent = manualStimuli.length > 0 ? manualStimuli.length + ' added' : 'Optional';
  }

  function simulateManualStimUpload() {
    const idx = manualStimuli.length;
    const icons = ['🥗', '🍲', '📦', '🎨', '📸'];
    const names = ['Concept A', 'Concept B', 'Concept C', 'Concept D', 'Concept E'];
    manualStimuli.push({
      name: names[idx] || 'Concept ' + String.fromCharCode(65 + idx),
      meta: 'stimulus-' + (idx + 1) + '.png · Just uploaded',
      icon: icons[idx] || '📄'
    });
    renderStimulusTab();
  }

  function removeManualStim(idx) {
    manualStimuli.splice(idx, 1);
    renderStimulusTab();
  }

  // ===== ADD / DELETE QUESTIONS =====

  function simulateQuestionUpload() {
    // Simulate uploading questions from a document
    const uploadedQuestions = [
      { title: 'How satisfied are you with this product?', type: 'Likert Scale', icon: '⊞', answers: ['Very Dissatisfied', 'Dissatisfied', 'Neutral', 'Satisfied', 'Very Satisfied'], ai: '' },
      { title: 'What feature do you value most?', type: 'Single Select', icon: '◉', answers: ['Ease of use', 'Design quality', 'Performance', 'Price', 'Customer support'], ai: '' },
      { title: 'Any additional feedback?', type: 'Short Text', icon: '✎', answers: [], ai: '' },
    ];
    questionData.push(...uploadedQuestions);
    renderQuestionList();
    selectQuestion(questionData.length - uploadedQuestions.length);
  }

  function addQuestion(type) {
    const qType = type || 'Single Select';
    const newQ = {
      title: '',
      type: qType,
      icon: getTypeIcon(qType),
      answers: getDefaultAnswersForType(qType),
      ai: '' // No AI suggestion for manual questions
    };
    questionData.push(newQ);
    renderQuestionList();

    // Select the new question
    activeQuestion = -1; // force selectQuestion to run
    selectQuestion(questionData.length - 1);

    // Focus the question title input
    setTimeout(() => {
      const qInput = document.getElementById('q-input');
      if (qInput) {
        qInput.focus();
        qInput.placeholder = 'Type your question here…';
      }
    }, 50);

    // Update the editor bar if it's showing
    if (buildPhase === 'editor' && currentStep === 4) {
      showBuildEditorBar();
    }
  }

  function deleteQuestion(idx) {
    if (questionData.length <= 1) {
      // Don't delete the last question — show empty state instead
      questionData.splice(idx, 1);
      activeQuestion = -1;
      renderQuestionList();
      showEditorEmptyState();
      return;
    }
    questionData.splice(idx, 1);
    // Select adjacent question
    if (activeQuestion >= questionData.length) {
      activeQuestion = questionData.length - 1;
    }
    renderQuestionList();
    const newIdx = Math.min(idx, questionData.length - 1);
    activeQuestion = -1; // force refresh
    selectQuestion(newIdx);
  }

  function showEditorEmptyState() {
    const editorContent = document.getElementById('q-editor-content');
    if (!editorContent) return;
    editorContent.innerHTML = `
      <div class="q-editor-empty">
        <div class="empty-icon">✎</div>
        <div class="empty-title">Add your first question</div>
        <div class="empty-sub">Click the button below or use "+ Add Question" in the sidebar</div>
        <button class="empty-add-btn" onclick="addQuestion()">+ Add Question</button>
      </div>`;
  }

  function updateQuestionTitle(value) {
    if (activeQuestion < 0 || activeQuestion >= questionData.length) return;
    questionData[activeQuestion].title = value;
    // Update sidebar label live
    const qItem = document.querySelector(`.q-item[data-qi="${activeQuestion}"]`);
    if (qItem) {
      const shortTitle = value || 'Untitled question';
      const displayTitle = shortTitle.length > 22 ? shortTitle.substring(0, 22) + '…' : shortTitle;
      // Rebuild innerHTML preserving q-num and q-type-badge
      const num = qItem.querySelector('.q-num');
      const badge = qItem.querySelector('.q-type-badge');
      if (num && badge) {
        qItem.innerHTML = '';
        qItem.appendChild(num);
        qItem.append(' ' + displayTitle + ' ');
        qItem.appendChild(badge);
      }
    }
  }

  function updateAnswerOption(idx, value) {
    if (activeQuestion < 0 || activeQuestion >= questionData.length) return;
    questionData[activeQuestion].answers[idx] = value;
  }

  function addAnswerOption() {
    if (activeQuestion < 0 || activeQuestion >= questionData.length) return;
    const q = questionData[activeQuestion];
    const newIdx = q.answers.length + 1;
    q.answers.push('Option ' + newIdx);
    // Re-render answers
    renderAnswersForQuestion(activeQuestion);
  }

  function removeAnswerOption(idx) {
    if (activeQuestion < 0 || activeQuestion >= questionData.length) return;
    const q = questionData[activeQuestion];
    if (q.answers.length <= 1) return; // Keep at least one option
    q.answers.splice(idx, 1);
    renderAnswersForQuestion(activeQuestion);
  }

  function renderAnswersForQuestion(qIdx) {
    const q = questionData[qIdx];
    const answersContainer = document.getElementById('q-answers');
    if (!answersContainer) return;

    if (q.type === 'Short Text') {
      answersContainer.innerHTML = '<div style="padding:16px 0;border-bottom:1px solid var(--rule);"><textarea class="textarea-mock" style="min-height:60px;" placeholder="Respondent types their answer here…"></textarea></div>';
    } else if (q.type === 'Slider') {
      const minLabel = q.answers[0] || '0';
      const maxLabel = q.answers[1] || '10';
      answersContainer.innerHTML = `<div style="padding:20px 0;border-bottom:1px solid var(--rule);">
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <div style="flex:1;"><label style="font-size:10px;color:var(--light);display:block;margin-bottom:4px;">MIN LABEL</label><input class="answer-text" value="${minLabel}" oninput="updateAnswerOption(0, this.value)" style="width:100%;border:none;border-bottom:1px solid var(--rule);padding:6px 0;font-size:13px;font-family:inherit;"></div>
          <div style="flex:1;"><label style="font-size:10px;color:var(--light);display:block;margin-bottom:4px;">MAX LABEL</label><input class="answer-text" value="${maxLabel}" oninput="updateAnswerOption(1, this.value)" style="width:100%;border:none;border-bottom:1px solid var(--rule);padding:6px 0;font-size:13px;font-family:inherit;"></div>
        </div>
        <div style="height:4px;background:var(--rule);border-radius:2px;position:relative;"><div style="position:absolute;left:65%;top:-5px;width:14px;height:14px;border-radius:50%;background:var(--black);border:2px solid var(--bg);box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div></div></div>`;
    } else {
      let html = '';
      const shape = q.type === 'Multi Select' ? 'border-radius:2px;' : '';
      q.answers.forEach((a, i) => {
        html += `<div class="answer-option">
          <div class="answer-radio" style="${shape}"></div>
          <input class="answer-text" value="${a}" oninput="updateAnswerOption(${i}, this.value)">
          <button class="answer-remove" onclick="removeAnswerOption(${i})" title="Remove option">×</button>
          <span class="answer-drag">⠿</span>
        </div>`;
      });
      answersContainer.innerHTML = html;
    }
  }

  function initializeManualEditor() {
    // Clear question data for fresh start
    questionData.length = 0;
    activeQuestion = -1;
    editingStimulus = false;
    manualStimuli = [];

    // Switch to editor phase
    buildPhase = 'editor';
    pbActivate(stepIndexOf('questions'));

    // Hide the pre-filled stim-preview-bar (it's for AI mode)
    const stimBar = document.getElementById('stim-preview-bar');
    if (stimBar) stimBar.style.display = 'none';

    // Show tabs and ensure we're on Questions tab
    showEditorTabs();
    switchEditorTab('questions');

    // Show empty state
    renderQuestionList();
    showEditorEmptyState();

    // Update subtitle
    const subEl = document.querySelector('[data-screen="editor"] .screen-sub');
    if (subEl) subEl.textContent = 'Add questions, set types, and configure options.';

    // Update title
    const titleEl = document.querySelector('[data-screen="editor"] .screen-title');
    if (titleEl) titleEl.textContent = 'Build Your Questions';
  }

  // Tabs
  function selectTab(el) {
    el.parentElement.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  // Editable insights
  function toggleEdit(btn) {
    const col = btn.closest('.finding-insight-col');
    const textEl = col.querySelector('.finding-insight-text');
    const noteEl = col.querySelector('.insight-note');
    const isEditing = textEl.contentEditable === 'true';
    if (isEditing) {
      textEl.contentEditable = 'false';
      btn.textContent = 'Edit';
      noteEl.textContent = 'Edited';
      noteEl.style.fontStyle = 'normal';
      noteEl.style.color = 'var(--mid)';
    } else {
      textEl.contentEditable = 'true';
      textEl.focus();
      btn.textContent = 'Save';
      noteEl.textContent = 'Editing — click Save when done';
      noteEl.style.fontStyle = 'normal';
    }
  }

  // Build panel interactions
  let briefUploaded = false;

  function checkBuildReady() {
    const hasPrompt = document.getElementById('ai-prompt').value.trim().length > 0;
    const ready = hasPrompt || briefUploaded;
    if (ready && mode === 'page-builder') {
      showPbConfirm(stepIndexOf('questions'), 'Generate with AI');
    } else if (mode === 'page-builder') {
      resetPbBar();
    }
  }

  function simulateStimulusStep() {
    document.getElementById('stim-gateway-empty').style.display = 'none';
    document.getElementById('stim-gateway-loaded').style.display = '';
    if (mode === 'page-builder') {
      showPbConfirm(stepIndexOf('stimulus'), 'Stimulus uploaded');
    }
  }

  function removeStimulusItem(e) {
    e.stopPropagation();
    const card = e.target.closest('.stim-thumb-card');
    card.style.display = 'none';
    const visible = document.querySelectorAll('#stim-gateway-loaded .stim-thumb-card:not([style*="display: none"])');
    if (visible.length === 0) {
      document.getElementById('stim-gateway-loaded').style.display = 'none';
      document.getElementById('stim-gateway-empty').style.display = '';
      if (mode === 'page-builder') resetPbBar();
    }
  }

  function simulateBriefUpload() {
    briefUploaded = true;
    document.getElementById('brief-upload-zone').style.display = 'none';
    document.getElementById('brief-uploaded').style.display = '';
    checkBuildReady();
  }

  function removeBrief(e) {
    e.stopPropagation();
    briefUploaded = false;
    document.getElementById('brief-upload-zone').style.display = '';
    document.getElementById('brief-uploaded').style.display = 'none';
    checkBuildReady();
  }

  function simulateStimUpload() {
    document.getElementById('stim-empty-zone').style.display = 'none';
    document.getElementById('stim-loaded').style.display = '';
  }

  function removeStim(e) {
    e.stopPropagation();
    const card = e.target.closest('.stim-thumb-card');
    card.style.display = 'none';
    // Check if all stim cards are hidden
    const visible = document.querySelectorAll('#stim-loaded .stim-thumb-card:not([style*="display: none"])');
    if (visible.length === 0) {
      document.getElementById('stim-loaded').style.display = 'none';
      document.getElementById('stim-empty-zone').style.display = '';
    }
  }

  // AI generation loading overlay
  const generationSteps = [
    { label: 'Analysing your research objectives…', sub: 'Reading prompt and brief' },
    { label: 'Reviewing stimulus materials…', sub: 'Detecting concepts and formats' },
    { label: 'Selecting survey type…', sub: 'Concept Testing' },
    { label: 'Defining target audience…', sub: 'Multi-Segment · 3 groups · n=600' },
    { label: 'Selecting methodology…', sub: 'Sequential monadic design' },
    { label: 'Generating questions…', sub: 'Writing 8 survey questions' },
    { label: 'Adding answer scales…', sub: 'Matching scales to question types' },
    { label: 'Optimising question order…', sub: 'Reducing bias and fatigue' },
    { label: 'Running quality checks…', sub: 'Checking clarity and balance' },
    { label: 'Finalising survey…', sub: 'Almost ready' },
  ];

  const launchSteps = [
    { label: 'Launching survey…', sub: 'Preparing distribution' },
    { label: 'Distributing to audiences…', sub: 'Sending to 3 segments' },
    { label: 'Collecting responses…', sub: 'Simulating fieldwork' },
    { label: 'Analysing results…', sub: 'Processing 850 responses' },
    { label: 'Generating insights…', sub: 'AI extracting key findings' },
    { label: 'Building results canvas…', sub: 'Almost ready' },
  ];

  function showGeneratingOverlay(onComplete, customSteps, sidebarLabel) {
    const overlay = document.getElementById('loading-overlay');
    const stepEl = document.getElementById('loading-step');
    const subEl = document.getElementById('loading-sub');
    const progressFill = document.getElementById('loading-progress-fill');
    const steps = customSteps || generationSteps;
    const spinnerLabel = sidebarLabel || 'Generating…';

    // In builder mode: add spinner to sidebar step and update label
    let sidebarItem = null;
    let originalLabel = '';
    if (mode === 'page-builder') {
      sidebarItem = document.querySelector(`.pb-item[data-pb="${currentStep}"]`);
      if (sidebarItem) {
        originalLabel = sidebarItem.querySelector('.pb-label').textContent;
        sidebarItem.classList.add('generating');
        sidebarItem.querySelector('.pb-label').textContent = spinnerLabel;
      }
    }

    // Reset
    stepEl.textContent = '';
    subEl.textContent = '';
    progressFill.style.transition = 'none';
    progressFill.style.width = '0%';
    void progressFill.offsetWidth; // force reflow
    progressFill.style.transition = 'width 0.6s ease';

    overlay.classList.add('active');

    const totalSteps = steps.length;
    const totalDuration = 6000 + Math.random() * 3000; // 6–9 seconds
    const stepDuration = totalDuration / totalSteps;
    let i = 0;

    function showStep() {
      if (i >= totalSteps) {
        // Done — fade out and proceed
        progressFill.style.width = '100%';
        stepEl.textContent = 'Done';
        subEl.textContent = '';
        setTimeout(() => {
          overlay.classList.remove('active');
          // Remove sidebar generating state
          if (sidebarItem) {
            sidebarItem.classList.remove('generating');
            sidebarItem.querySelector('.pb-label').textContent = originalLabel;
          }
          setTimeout(() => {
            if (onComplete) onComplete();
          }, 400); // wait for fade-out
        }, 600);
        return;
      }

      const step = steps[i];
      stepEl.style.opacity = '0';
      setTimeout(() => {
        stepEl.textContent = step.label;
        subEl.textContent = step.sub;
        stepEl.style.opacity = '1';
        progressFill.style.width = ((i + 1) / totalSteps * 100) + '%';
      }, 150);

      i++;
      setTimeout(showStep, stepDuration);
    }

    // Start after a short delay
    setTimeout(showStep, 300);
  }

  function generateAndContinue() {
    completeStep(1);
    showGeneratingOverlay(() => wizardNext(4));
  }

  function confirmBuild() {
    completeStep(1);
    if (mode === 'page-builder') {
      hidePbConfirm();
      showGeneratingOverlay(() => {
        buildPhase = 'editor';
        pbActivate(stepIndexOf('questions'));
        selectQuestion(0);
      });
    } else {
      showGeneratingOverlay(() => wizardNext(4));
    }
  }

  // Page-builder confirm bar — always visible in builder mode
  let pbPendingStep = null;
  let pbReady = false;

  function getPbHint(stepNum) {
    const name = stepNameOf(stepNum);
    const hints = {
      type: 'Select a survey type to continue',
      audience: 'Select an audience to continue',
      stimulus: 'Add stimulus materials to continue',
      questions: 'Choose how to add questions',
      preview: 'Preview your survey, then launch when ready',
    };
    return hints[name] || '';
  }

  function getPbCtaLabel(stepNum) {
    const name = stepNameOf(stepNum);
    const labels = {
      type: 'Confirm & continue →',
      audience: 'Confirm & continue →',
      stimulus: 'Confirm & continue →',
      questions: 'Confirm & continue →',
      preview: 'Launch survey →',
    };
    return labels[name] || 'Continue →';
  }

  // Build phase tracks whether the method step has completed
  let buildPhase = 'form'; // 'form' or 'editor'

  // Maps sidebar step → data-screen
  function screenForStep(step) {
    const name = stepNameOf(step);
    // 'questions' step shows the questions-gateway screen (until editor phase)
    if (name === 'questions' && buildPhase !== 'editor') return 'questions-gateway';
    if (name === 'questions' && buildPhase === 'editor') return 'editor';
    return name;
  }

  function updatePbBar() {
    if (mode !== 'page-builder') return;
    const el = document.getElementById('pb-confirm');
    const labelEl = document.getElementById('pb-confirm-label');
    const goBtn = document.getElementById('pb-confirm-go');
    const changeBtn = document.querySelector('.pb-confirm-secondary');
    el.classList.add('visible');
    goBtn.textContent = getPbCtaLabel(currentStep);

    const stepName = stepNameOf(currentStep);
    const isEditorOrPreview = (stepName === 'questions' && buildPhase === 'editor') || stepName === 'preview';
    if (isEditorOrPreview) {
      labelEl.textContent = getPbHint(currentStep);
      labelEl.classList.add('hint');
      goBtn.disabled = false;
      changeBtn.style.display = 'none';
      pbPendingStep = currentStep;
      pbReady = true;
    } else if (pbReady && pbPendingStep) {
      labelEl.classList.remove('hint');
      goBtn.disabled = false;
      changeBtn.style.display = '';
    } else {
      labelEl.textContent = getPbHint(currentStep);
      labelEl.classList.add('hint');
      goBtn.disabled = true;
      changeBtn.style.display = 'none';
    }
  }

  function showPbConfirm(step, label) {
    pbPendingStep = step;
    pbReady = true;
    const labelEl = document.getElementById('pb-confirm-label');
    const goBtn = document.getElementById('pb-confirm-go');
    const changeBtn = document.querySelector('.pb-confirm-secondary');
    const name = stepNameOf(step);
    const stepNames = { type: 'Survey type', audience: 'Audience', stimulus: 'Stimulus', questions: 'Method' };
    labelEl.innerHTML = `${stepNames[name] || name}: <strong>${label}</strong>`;
    labelEl.classList.remove('hint');
    if (name === 'questions' && selectedBuildMethod === 'ai') {
      goBtn.textContent = 'Generate questions →';
    } else {
      goBtn.textContent = getPbCtaLabel(step) || 'Continue →';
    }
    goBtn.disabled = false;
    changeBtn.style.display = '';
    document.getElementById('pb-confirm').classList.add('visible');
  }

  function hidePbConfirm() {
    document.getElementById('pb-confirm').classList.remove('visible');
    pbPendingStep = null;
    pbReady = false;
  }

  function resetPbBar() {
    pbPendingStep = null;
    pbReady = false;
    updatePbBar();
  }

  function confirmPbStep() {
    if (!pbPendingStep || !pbReady) return;
    const step = pbPendingStep;
    const name = stepNameOf(step);
    pbPendingStep = null;
    pbReady = false;
    completeStep(step);

    if (name === 'preview') {
      // Final step — launch
      for (let i = 1; i <= totalStepCount(); i++) completeStep(i);
      updatePbSidebar();
      hidePbConfirm();
      showGeneratingOverlay(() => {
        showResultsCanvas();
      }, launchSteps, 'Launching…');
    } else if (name === 'type') {
      hidePbConfirm();
      pbActivate(stepIndexOf('audience'));
    } else if (name === 'audience') {
      hidePbConfirm();
      const nextStep = flowSteps.includes('stimulus') ? 'stimulus' : 'questions';
      pbActivate(stepIndexOf(nextStep));
    } else if (name === 'stimulus') {
      hidePbConfirm();
      pbActivate(stepIndexOf('questions'));
    } else if (name === 'questions' && buildPhase === 'editor') {
      // Already in editor — move to preview
      hidePbConfirm();
      pbActivate(stepIndexOf('preview'));
    } else if (name === 'questions') {
      hidePbConfirm();
      if (selectedBuildMethod === 'ai') {
        // AI path: generate questions
        showGeneratingOverlay(() => {
          if (questionData.length === 0) {
            questionData.push(...JSON.parse(JSON.stringify(originalQuestionData)));
          }
          buildPhase = 'editor';
          pbActivate(stepIndexOf('questions'));
          hideEditorTabs();
          const stimBar = document.getElementById('stim-preview-bar');
          if (stimBar) stimBar.style.display = flowSteps.includes('stimulus') ? '' : 'none';
          const bl = document.getElementById('builder-layout');
          if (bl) bl.style.display = '';
          selectQuestion(0);
        });
      } else if (selectedBuildMethod === 'manual') {
        initializeManualEditor();
      } else if (selectedBuildMethod === 'template') {
        if (questionData.length === 0) {
          questionData.push(...JSON.parse(JSON.stringify(originalQuestionData)));
        }
        buildPhase = 'editor';
        pbActivate(stepIndexOf('questions'));
        hideEditorTabs();
        const stimBar = document.getElementById('stim-preview-bar');
        if (stimBar) stimBar.style.display = 'none';
        const bl = document.getElementById('builder-layout');
        if (bl) bl.style.display = '';
        selectQuestion(0);
      }
    } else {
      // Generic fallback
      pbActivate(step + 1);
    }
  }

  function showBuildEditorBar() {
    const el = document.getElementById('pb-confirm');
    const labelEl = document.getElementById('pb-confirm-label');
    const goBtn = document.getElementById('pb-confirm-go');
    const changeBtn = document.querySelector('.pb-confirm-secondary');

    const hasQuestions = questionData.length > 0;
    if (selectedBuildMethod === 'manual' && !hasQuestions) {
      labelEl.textContent = 'Add at least one question to continue';
      labelEl.classList.add('hint');
      goBtn.textContent = 'Continue to preview →';
      goBtn.disabled = true;
    } else {
      labelEl.textContent = 'Edit questions if needed, or continue when ready';
      labelEl.classList.add('hint');
      goBtn.textContent = 'Continue to preview →';
      goBtn.disabled = false;
    }
    changeBtn.style.display = 'none';
    pbPendingStep = stepIndexOf('questions');
    pbReady = hasQuestions;
    el.classList.add('visible');
  }

  function showResultsCanvas() {
    document.getElementById('pb-layout').style.display = 'none';
    hidePbConfirm();
    const resultsScreen = document.querySelector('.wizard-screen[data-screen="results"]');
    if (resultsScreen) {
      resultsScreen.classList.add('wizard-active');
      resultsScreen.style.display = 'block';
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function editSurveyFromResults() {
    const resultsScreen = document.querySelector('.wizard-screen[data-screen="results"]');
    if (resultsScreen) {
      resultsScreen.classList.remove('wizard-active');
      resultsScreen.style.display = '';
    }
    document.getElementById('pb-layout').style.display = '';
    buildPhase = 'editor';
    pbActivate(stepIndexOf('questions'));
  }

  function showLaunchedState() {
    const el = document.getElementById('pb-confirm');
    const labelEl = document.getElementById('pb-confirm-label');
    const goBtn = document.getElementById('pb-confirm-go');
    const changeBtn = document.querySelector('.pb-confirm-secondary');
    labelEl.innerHTML = '✓ Survey launched — viewing results';
    labelEl.classList.remove('hint');
    labelEl.style.fontWeight = '600';
    goBtn.style.display = 'none';
    changeBtn.style.display = 'none';
    el.classList.add('visible');
  }

  // Page-builder mode
  function pbActivate(n) {
    currentStep = n;
    for (let i = 1; i < n; i++) completedSteps.add(i);

    const screen = screenForStep(n);

    // Move the active wizard-screen into pb-main
    const pbMain = document.getElementById('pb-main');
    const pbLayout = document.getElementById('pb-layout');
    document.querySelectorAll('.wizard-screen').forEach(s => {
      s.classList.remove('wizard-active');
      if (pbMain.contains(s)) {
        pbLayout.insertAdjacentElement('afterend', s);
      }
    });

    const target = document.querySelector(`.wizard-screen[data-screen="${screen}"]`);
    if (target) {
      target.classList.add('wizard-active');
      pbMain.innerHTML = '';
      pbMain.appendChild(target);
    }

    updatePbSidebar();
    resetPbBar();

    const stepName = stepNameOf(n);
    if (stepName === 'questions' && buildPhase === 'editor') {
      showBuildEditorBar();
      if (selectedBuildMethod === 'manual') {
        showEditorTabs();
        switchEditorTab('questions');
      } else {
        hideEditorTabs();
      }
    } else {
      hideEditorTabs();
    }

    if (pbMain.scrollTo) pbMain.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function pbNav(n) {
    // In dev mode, allow navigating to any step
    if (!DEV_MODE) {
      if (!completedSteps.has(n) && n !== currentStep && n > currentStep) return;
    }
    pbActivate(n);
  }

  function updatePbSidebar() {
    renderSidebar();
  }

  function pbNav(n) {
    // In dev mode, allow navigating to any step
    if (!DEV_MODE) {
      if (!completedSteps.has(n) && n !== currentStep && n > currentStep) return;
    }
    pbActivate(n);
  }

  // Init — apply defaults for wizard/single-page modes
  function applyDefaults() {
    // Pre-select Type
    completedSteps.add(1);
    document.querySelector('#type-grid .type-card[data-type="concept"]').classList.add('selected');
    rebuildFlow('concept');
    // Pre-select Audience
    completedSteps.add(2);
    document.querySelector('#aud-options .aud-card[data-aud="single"]').classList.add('selected');
    document.getElementById('single-panel').classList.remove('hidden');
    document.getElementById('multi-panel').classList.add('hidden');
    const firstSug = document.querySelector('.aud-suggestion');
    if (firstSug) firstSug.classList.add('picked');
    completedSteps.add(stepIndexOf('audience'));
  }

  function clearDefaults() {
    completedSteps.clear();
    document.querySelectorAll('.type-card.selected, .aud-card.selected, .build-card.selected, .template-option.selected').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.aud-suggestion.picked').forEach(s => s.classList.remove('picked'));
    document.getElementById('multi-panel').classList.add('hidden');
    document.getElementById('single-panel').classList.add('hidden');
    document.querySelectorAll('.build-panel').forEach(p => p.classList.remove('active'));
    // Re-show template section
    const tplSection = document.getElementById('template-section');
    if (tplSection) tplSection.style.display = '';
    // Reset build panel
    resetBuildPanel();
  }

  function resetBuildPanel() {
    document.getElementById('ai-prompt').value = '';
    briefUploaded = false;
    document.getElementById('brief-upload-zone').style.display = '';
    document.getElementById('brief-uploaded').style.display = 'none';
    document.getElementById('stim-empty-zone').style.display = '';
    document.getElementById('stim-loaded').style.display = 'none';
    // Restore stim cards visibility
    document.querySelectorAll('#stim-loaded .stim-thumb-card').forEach(c => c.style.display = '');
  }

  // Initialize in builder mode
  setMode('page-builder');
</script>
</body>
</html>
